import{r,j as e,a as ue,b as N}from"./index-DbvXYXc0.js";import{N as me,O as xe,P as fe}from"./adminApi-C-vdNBvN.js";import{C as A,a as R}from"./card-6tZ6FSP9.js";import{g as pe,f as he}from"./formatLastSeen-CGcOyupo.js";import{C as y,r as E}from"./chart-Bcjh2pZL.js";import{U as ge}from"./users-E8rCSFRH.js";import{C as be}from"./calendar-check-oloTnN63.js";import{D as je}from"./dollar-sign-o41FEJ1i.js";import{C as X}from"./circle-pJ_qQuI9.js";import{C as ye}from"./clock-BKbRfuIG.js";import{M as ke}from"./mouse-pointer-click-DbtOab9b.js";y.register(...E);const Ce=({data:l})=>{const u=r.useRef(null),n=r.useRef(null);return r.useEffect(()=>{if(!l?.length||!u.current)return;const c=u.current.getContext("2d");n.current&&(n.current.destroy(),n.current=null);const m=l.map(o=>o.label),g=[{key:"pending",label:"Pending",color:"#facc15"},{key:"completed",label:"Completed",color:"#22c55e"},{key:"cancelled",label:"Cancelled",color:"#ef4444"},{key:"total",label:"Total",color:"#3b82f6"}];return n.current=new y(c,{type:"line",data:{labels:m,datasets:g.map(({key:o,label:a,color:x})=>({label:a,data:l.map(f=>f[o]??0),borderColor:x,backgroundColor:`${x}20`,fill:!1,tension:.2}))},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},scales:{x:{grid:{display:!1},ticks:{maxRotation:45,font:{size:11}}},y:{beginAtZero:!0,ticks:{stepSize:1,font:{size:11}},grid:{color:"rgba(0,0,0,0.06)"}}},animation:{duration:400}}}),()=>{n.current&&(n.current.destroy(),n.current=null)}},[l]),!l||l.length===0?null:e.jsx("div",{className:"w-full h-[320px]",children:e.jsx("canvas",{ref:u})})};y.register(...E);const ve="#00A19C",Ne=({data:l})=>{const u=r.useRef(null),n=r.useRef(null);return r.useEffect(()=>{if(!l?.length||!u.current)return;const c=u.current.getContext("2d");return n.current&&(n.current.destroy(),n.current=null),n.current=new y(c,{type:"bar",data:{labels:l.map(m=>m.label),datasets:[{label:"Cars",data:l.map(m=>m.count),backgroundColor:ve,borderRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:m=>"Cars: "+m.raw}}},scales:{x:{grid:{display:!1},ticks:{maxRotation:45,minRotation:0,font:{size:12}}},y:{beginAtZero:!0,ticks:{stepSize:1,font:{size:12}},grid:{color:"rgba(0,0,0,0.06)"}}},animation:{duration:600}}}),()=>{n.current&&(n.current.destroy(),n.current=null)}},[l]),l?.length?e.jsx("div",{className:"w-full h-full min-h-[280px]",children:e.jsx("canvas",{ref:u})}):null};y.register(...E);const we=({data:l})=>{const u=r.useRef(null),n=r.useRef(null),c=l?.length&&"count"in(l[0]??{});return r.useEffect(()=>{if(!l?.length||!u.current)return;const m=u.current.getContext("2d");n.current&&(n.current.destroy(),n.current=null);const g=l.map(a=>a.label),o=c?[{label:"Clicks",data:l.map(a=>a.count??0),borderColor:"#00A19C",backgroundColor:"rgba(0,161,156,0.15)",fill:!0,tension:.3}]:[{label:"App Store (iOS)",data:l.map(a=>a.ios??0),borderColor:"#007AFF",backgroundColor:"rgba(0,122,255,0.15)",fill:!0,tension:.3},{label:"Play Store (Android)",data:l.map(a=>a.android??0),borderColor:"#34C759",backgroundColor:"rgba(52,199,89,0.15)",fill:!0,tension:.3}];return n.current=new y(m,{type:"line",data:{labels:g,datasets:o},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},tooltip:{mode:"index",callbacks:{afterBody:a=>`Total: ${a.reduce((f,C)=>f+(C.raw??0),0)}`}}},scales:{x:{grid:{display:!1},ticks:{maxRotation:45,minRotation:0,font:{size:11}}},y:{beginAtZero:!0,ticks:{stepSize:1,font:{size:11}},grid:{color:"rgba(0,0,0,0.06)"}}},animation:{duration:400}}}),()=>{n.current&&(n.current.destroy(),n.current=null)}},[l,c]),l?.length?e.jsx("div",{className:"w-full h-full min-h-[280px]",children:e.jsx("canvas",{ref:u})}):null};y.register(...E);const Se=({byStore:l})=>{const u=r.useRef(null),n=r.useRef(null),c=l?.playstore??0,m=l?.appstore??0,g=c+m;return r.useEffect(()=>{if(!u.current)return;const o=u.current.getContext("2d");return n.current&&(n.current.destroy(),n.current=null),n.current=new y(o,{type:"pie",data:{labels:["Play Store","App Store"],datasets:[{data:[c,m],backgroundColor:["#34C759","#007AFF"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:a=>{const x=a.raw??0,f=g>0?(x/g*100).toFixed(1):0;return`${a.label}: ${x} (${f}%)`}}}},animation:{duration:400}}}),()=>{n.current&&(n.current.destroy(),n.current=null)}},[c,m]),e.jsx("div",{className:"w-full h-full min-h-[200px]",children:e.jsx("canvas",{ref:u})})},j=l=>l.toISOString().split("T")[0],De=(l,u,n)=>{const c={},m=new Date,g=(o,a)=>{o[a]||(o[a]=0),o[a]++};if(u==="day"){const o=new Date(n.from),a=new Date(n.to);for(;o<=a;){const x=j(o);c[x]={label:o.toLocaleDateString("en-US",{month:"short",day:"numeric"}),total:0,pending:0,completed:0,cancelled:0},o.setDate(o.getDate()+1)}return l.forEach(x=>{if(!x.start_datetime)return;const f=j(new Date(x.start_datetime));c[f]&&(c[f].total++,g(c[f],x.booking_request_status))}),Object.values(c)}if(u==="week"){for(let o=6;o>=0;o--){const a=new Date;a.setDate(m.getDate()-o);const x=j(a);c[x]={label:a.toLocaleDateString("en-US",{weekday:"short"}),total:0,pending:0,completed:0,cancelled:0}}return l.forEach(o=>{if(!o.start_datetime)return;const a=j(new Date(o.start_datetime));c[a]&&(c[a].total++,g(c[a],o.booking_request_status))}),Object.values(c)}if(u==="month"){const o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return o.forEach(a=>{c[a]={label:a,total:0,pending:0,completed:0,cancelled:0}}),l.forEach(a=>{if(!a.start_datetime)return;const x=new Date(a.start_datetime);if(x.getFullYear()!==m.getFullYear())return;const f=x.toLocaleString("en-US",{month:"short"});c[f].total++,g(c[f],a.booking_request_status)}),o.map(a=>c[a])}return l.forEach(o=>{if(!o.start_datetime)return;const a=new Date(o.start_datetime).getFullYear();c[a]||(c[a]={label:String(a),total:0,pending:0,completed:0,cancelled:0}),c[a].total++,g(c[a],o.booking_request_status)}),Object.values(c).sort((o,a)=>Number(o.label)-Number(a.label))},Fe=()=>{const[l,u]=r.useState({users:0,cars:0,bookings:0,revenue:0}),[n,c]=r.useState(null),[m,g]=r.useState([]),[o,a]=r.useState(!0),x=new Date,f=new Date;f.setDate(x.getDate()-29);const[C,ee]=r.useState("day"),[_,T]=r.useState({from:f,to:x}),[B,P]=r.useState([]),[te,$]=r.useState(!0);r.useEffect(()=>{(async()=>{try{a(!0);const s=await N.get("/admin/users"),i=await N.get("/admin/cars",{params:{per_page:1,page:1}}),d=await N.get("/admin/bookings"),p=await N.get("/admin/payments"),b=(i.data?.cars??i.data)?.total??i.data?.meta?.total??0;u({users:s.data?.users?.total??0,cars:b,bookings:d.data?.bookings?.total??d.data?.total??0,revenue:p.data?.total_revenue??p.data?.revenue??0})}catch(s){console.error("Dashboard stats error:",s)}finally{a(!1)}})()},[]),r.useEffect(()=>{(async()=>{try{const s=await me({minutes:30}),i=s.data??s,d=i?.online_users??i?.users??i?.data??[];g(Array.isArray(d)?d:[]),c(i?.online_users_count??(Array.isArray(d)?d.length:0))}catch{c(0),g([])}})()},[]),r.useEffect(()=>{(async()=>{try{$(!0);const i=(await N.get("/admin/bookings"))?.data?.bookings?.data||[],d=De(i,C,_);P(d)}catch(s){console.error("Chart error:",s),P([])}finally{$(!1)}})()},[C,_]);const L=({title:t,value:s,icon:i,color:d,subtitle:p})=>e.jsx(A,{children:e.jsxs(R,{className:"p-6 flex items-center gap-4",children:[e.jsx("div",{className:`w-12 h-12 rounded-xl ${d} flex items-center justify-center`,children:e.jsx(i,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t}),e.jsx("h2",{className:"text-2xl font-bold",children:o?"—":s}),p!=null&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1 flex items-center gap-1",children:[e.jsx(X,{className:"w-2 h-2 fill-green-500 text-green-500"}),p]})]})]})}),[w,se]=r.useState([]),[S,ae]=r.useState(""),[M,F]=r.useState(""),[U,re]=r.useState([]);r.useEffect(()=>{(async()=>{try{const s=await N.get("admin/cars");se(s.data?.cars?.data||s.data?.cars||[])}catch(s){console.error("Cars fetch error",s)}})()},[]);const ne=t=>[...new Set(t.map(s=>s.make).filter(Boolean))].sort(),le=(t,s,i)=>{let d=[...t];i&&(d=d.filter(h=>h.model===i)),s&&(d=d.filter(h=>h.make===s));const p={};return d.forEach(h=>{let b;i&&s?b=`${h.make} ${h.model}`:i?b=h.make:s?b=h.model:b=h.make,b&&(p[b]=(p[b]||0)+1)}),Object.entries(p).map(([h,b])=>({label:h,count:b}))},oe=(t,s)=>{const i=s?t.filter(d=>d.make===s):t;return[...new Set(i.map(d=>d.model).filter(Boolean))].sort()};r.useEffect(()=>{F("")},[S]),r.useEffect(()=>{const t=le(w,S,M);re(t)},[w,S,M]);const[z,q]=r.useState([]),[D,ce]=r.useState("day"),[I,Y]=r.useState([]),[k,J]=r.useState({playstore:0,appstore:0}),[W,Z]=r.useState(0),[G,H]=r.useState(!0),[ie,K]=r.useState(!0),[Q,O]=r.useState(null),[v,V]=r.useState({from:(()=>{const t=new Date;return t.setDate(t.getDate()-29),t})(),to:new Date}),de=()=>D==="day"?7:D==="week"?28:30;return r.useEffect(()=>{(async()=>{try{H(!0),O(null);const s=await xe({period:D,days_back:de()});O(!0);const i=s.data??s,d=i.series??i.data?.series??[],p=i.by_store??i.data?.by_store??{playstore:0,appstore:0},h=i.total_clicks??i.data?.total_clicks??0;Y(Array.isArray(d)?d:[]),J(typeof p=="object"?p:{playstore:0,appstore:0}),Z(typeof h=="number"?h:0)}catch(s){O(s.response?.status===404?!1:null),s.response?.status!==404&&console.error("Clicks chart error",s),Y([]),J({playstore:0,appstore:0}),Z(0)}finally{H(!1)}})()},[D]),r.useEffect(()=>{(async()=>{try{K(!0);const s=await fe({date_from:j(v.from),date_to:j(v.to),per_page:100}),i=s.data??s,d=i.clicks??i.data?.clicks??i.data??i,p=d?.data??(Array.isArray(d)?d:[]);q(Array.isArray(p)?p:[])}catch(s){s.response?.status!==404&&console.error("Clicks list error",s),q([])}finally{K(!1)}})()},[v.from,v.to]),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Dashboard"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(L,{title:"Total Users",value:l.users,icon:ge,color:"bg-blue-500",subtitle:n!==null?`Online now: ${n}`:void 0}),e.jsx(L,{title:"Total Cars",value:l.cars,icon:ue,color:"bg-[#00A19C]"}),e.jsx(L,{title:"Total Bookings",value:l.bookings,icon:be,color:"bg-purple-500"}),e.jsx(L,{title:"Total Revenue",value:`$${l.revenue}`,icon:je,color:"bg-green-500"})]}),m.length>0&&e.jsx(A,{children:e.jsxs(R,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-4",children:[e.jsx(X,{className:"w-4 h-4 fill-green-500 text-green-500"}),"Online Users (",n,")"]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[240px] overflow-y-auto",children:m.slice(0,12).map(t=>{const s=pe(t),i=[t.first_name,t.last_name].filter(Boolean).join(" ")||t.username||`User #${t.id}`;return e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-lg border p-3 bg-muted/30",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:i}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:["@",t.username," • ",t.role]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground shrink-0",children:[e.jsx(ye,{className:"w-3.5 h-3.5"}),he(s)]})]},t.id)})}),m.length>12&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["+",m.length-12," more"]})]})}),e.jsx(A,{children:e.jsxs(R,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Booking Overview"}),e.jsxs("div",{className:"flex flex-col gap-3 min-w-[160px]",children:[e.jsxs("select",{value:C,onChange:t=>ee(t.target.value),className:"border rounded-md px-3 py-1 text-sm bg-background",children:[e.jsx("option",{value:"day",children:"Daily"}),e.jsx("option",{value:"week",children:"Week"}),e.jsx("option",{value:"month",children:"Month"}),e.jsx("option",{value:"year",children:"Year"})]}),C==="day"&&e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground mb-1 block",children:"From"}),e.jsx("input",{type:"date",value:j(_.from),onChange:t=>T(s=>({...s,from:new Date(t.target.value)})),className:"border rounded-md px-2 py-1 text-sm w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground mb-1 block",children:"To"}),e.jsx("input",{type:"date",value:j(_.to),onChange:t=>T(s=>({...s,to:new Date(t.target.value)})),className:"border rounded-md px-2 py-1 text-sm w-full"})]})]})]})]}),e.jsx("div",{className:"w-full h-[320px]",children:te?e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"Loading chart data..."}):B.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"No booking data"}):e.jsx(Ce,{data:B})})]})}),e.jsx(A,{children:e.jsxs(R,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Cars Distribution"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("select",{value:S,onChange:t=>ae(t.target.value),className:"border rounded-md px-3 py-1 text-sm bg-background",children:[e.jsx("option",{value:"",children:"All Makes"}),ne(w).map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsxs("select",{value:M,onChange:t=>F(t.target.value),className:"border rounded-md px-3 py-1 text-sm bg-background",disabled:!w.length,children:[e.jsx("option",{value:"",children:"All Models"}),oe(w,S).map(t=>e.jsx("option",{value:t,children:t},t))]})]})]}),e.jsx("div",{className:"h-[300px] w-full",children:U.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"No car data"}):e.jsx(Ne,{data:U})})]})}),e.jsx(A,{children:e.jsxs(R,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(ke,{className:"w-5 h-5"}),"Mobile App Store Clicks"]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("select",{value:D,onChange:t=>ce(t.target.value),className:"border rounded-md px-3 py-1.5 text-sm bg-background",children:[e.jsx("option",{value:"day",children:"Daily"}),e.jsx("option",{value:"week",children:"Weekly"}),e.jsx("option",{value:"month",children:"Monthly"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:j(v.from),onChange:t=>V(s=>({...s,from:new Date(t.target.value)})),className:"border rounded-md px-2 py-1 text-sm"}),e.jsx("span",{className:"text-muted-foreground",children:"–"}),e.jsx("input",{type:"date",value:j(v.to),onChange:t=>V(s=>({...s,to:new Date(t.target.value)})),className:"border rounded-md px-2 py-1 text-sm"})]})]})]}),Q===!1&&e.jsxs("p",{className:"text-sm text-amber-600 dark:text-amber-500 bg-amber-50 dark:bg-amber-950/30 rounded-lg p-3",children:["API not found (404). Ensure the backend exposes ",e.jsx("code",{className:"text-xs bg-amber-100 dark:bg-amber-900/50 px-1 rounded",children:"GET /api/admin/mobile-app-clicks"})," and ",e.jsx("code",{className:"text-xs bg-amber-100 dark:bg-amber-900/50 px-1 rounded",children:"GET /api/admin/mobile-app-clicks/chart"}),"."]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsx("div",{className:"lg:col-span-2 h-[300px]",children:G?e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"Loading chart..."}):I.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground gap-2",children:[e.jsx("span",{children:"No click data"}),Q===!0&&e.jsx("span",{className:"text-xs",children:"Clicks are recorded when users tap Play Store / App Store links."})]}):e.jsxs("div",{className:"h-full",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Timeline"}),e.jsx(we,{data:I})]})}),e.jsx("div",{className:"h-[260px] lg:h-[300px]",children:G?e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground text-sm",children:"Loading..."}):(k?.playstore||k?.appstore)>0?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"By store"}),e.jsx(Se,{byStore:k})]}):e.jsx("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground text-sm",children:e.jsx("span",{children:"No store breakdown yet"})})})]}),(k?.playstore||k?.appstore||W)>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Total: ",W," — Play Store: ",k?.playstore??0," · App Store: ",k?.appstore??0]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold mb-3",children:"Clickers list (date range below)"}),e.jsx("div",{className:"overflow-x-auto rounded-md border max-h-[320px] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-muted/50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-3",children:"Date"}),e.jsx("th",{className:"text-left p-3",children:"Store"}),e.jsx("th",{className:"text-left p-3",children:"IP"}),e.jsx("th",{className:"text-left p-3",children:"City"}),e.jsx("th",{className:"text-left p-3",children:"Country"})]})}),e.jsx("tbody",{children:ie?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-6 text-center text-muted-foreground",children:"Loading..."})}):z.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-6 text-center text-muted-foreground",children:"No clicks recorded"})}):[...z].sort((t,s)=>new Date(s.created_at||0)-new Date(t.created_at||0)).map(t=>e.jsxs("tr",{className:"border-t hover:bg-muted/30",children:[e.jsx("td",{className:"p-3",children:t.created_at?new Date(t.created_at).toLocaleString():"—"}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:`inline-flex px-2 py-0.5 rounded text-xs font-medium ${(t.store||"").includes("ios")?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:(t.store||"").toLowerCase().includes("app")?"App Store":"Play Store"})}),e.jsx("td",{className:"p-3 font-mono text-xs",children:t.ip||"—"}),e.jsx("td",{className:"p-3",children:t.city||"—"}),e.jsx("td",{className:"p-3",children:t.country_name||t.country||t.country_code||"—"})]},t.id||`${t.created_at}-${t.ip}`))})]})})]})]})})]})};export{Fe as default};
