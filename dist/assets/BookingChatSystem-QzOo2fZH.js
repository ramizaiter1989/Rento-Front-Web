import{r as l,l as Z,b as x,j as e,X as ee,a as A,P as re,e as te,C as ae}from"./index-DbvXYXc0.js";import{P as se,S as ne,a as ie,b as le}from"./pusher-BchfI1AD.js";import{m as o}from"./proxy-Rx_HuwO6.js";import{M as N}from"./message-circle-CPCE0lxB.js";import{A as M}from"./index-B12qvIYV.js";import{S as oe}from"./search-DsOkoVxz.js";import{S as U}from"./shield-Bm-1xR-G.js";import{C as ce}from"./chevron-right-DaEW3pZI.js";import{C as de}from"./check-check-DZSXyF6p.js";import{C as ue}from"./check-nqnuVgMJ.js";import{S as me}from"./send-DKa36EPT.js";import"./use-presence-CB-MpOZZ.js";const s={darkBlue:"#0E4C81",teal:"#008C95",limeGreen:"#8AC640",tealDim:"rgba(0, 140, 149, 0.1)",limeGreenDim:"rgba(138, 198, 64, 0.1)"};function Ce(){const[g,v]=l.useState([]),[n,$]=l.useState(null),[y,j]=l.useState([]),[w,k]=l.useState(""),[F,E]=l.useState(!1),[L,D]=l.useState(!0),[O,ge]=l.useState(!1),[H,u]=l.useState(null),[_,G]=l.useState(""),R=l.useRef(null),z=l.useRef(null),m=l.useRef(null),h=l.useRef(null),S=Z(),q=l.useRef(S.state?.bookingId??null),[d]=l.useState(()=>localStorage.getItem("token"));l.useEffect(()=>{console.log("Token:",d),console.log("API Base:","https://rento-lb.com/api/api")},[]);const K=r=>{const t=r?.created_at??r?.createdAt??r?.data?.created_at??null;return{id:r?.id??r?.data?.id??`rt-${Date.now()}`,booking_id:r?.booking_id??r?.data?.booking_id??n?.id,sender_id:r?.sender_id??r?.data?.sender_id??r?.sender?.id,receiver_id:r?.receiver_id??r?.data?.receiver_id??null,message:r?.message??r?.data?.message??"",read_at:r?.read_at??r?.data?.read_at??null,created_at:t,sender:r?.sender??r?.data?.sender??null}};l.useEffect(()=>{if(!d){console.error("No token found in localStorage"),u("Authentication required. Please log in.");return}window.Pusher=se,m.current=new ne({broadcaster:"pusher",key:"316e84fa5f5bf1a94b26",cluster:"ap1",forceTLS:!0,encrypted:!0,enabledTransports:["ws","wss"],authEndpoint:"https://rento-lb.com/api/api/broadcasting/auth",auth:{headers:{Authorization:`Bearer ${d}`,Accept:"application/json"}}});const r=m.current.connector.pusher;return r.connection.bind("initialized",()=>console.log("[PUSHER] initialized")),r.connection.bind("connecting",()=>console.log("[PUSHER] connecting...")),r.connection.bind("connected",()=>console.log("[PUSHER] ✅ connected")),r.connection.bind("disconnected",()=>console.log("[PUSHER] disconnected")),r.connection.bind("unavailable",()=>console.log("[PUSHER] unavailable")),r.connection.bind("failed",()=>console.log("[PUSHER] ❌ failed")),r.connection.bind("error",t=>console.error("[PUSHER] error:",t)),console.log("[ECHO] authEndpoint:","https://rento-lb.com/api/api/broadcasting/auth"),console.log("[ECHO] cluster:","ap1"),console.log("[ECHO] key:","316e84fa5f5bf1a94b26"),x.get("/profile").then(({data:t})=>{h.current=t.user?.id,console.log("Current user ID:",h.current)}).catch(t=>{console.error("Failed to fetch profile:",t),u("Failed to load user profile")}),()=>{m.current?.disconnect()}},[d]),l.useEffect(()=>{d&&Q()},[d]);const Q=async()=>{D(!0),u(null);try{const{data:r}=await x.get("/driver/bookings");console.log("Bookings response:",r);const a=(r.data||[]).filter(i=>i.booking_request_status==="confirmed"||i.booking_request_status==="accepted");v(a)}catch(r){console.error("Failed to fetch bookings:",r),u("Failed to load bookings"),v([])}finally{D(!1)}};l.useEffect(()=>{if(!g.length)return;const r=q.current??S.state?.bookingId;if(!r||n&&String(n.id)===String(r))return;const t=g.find(a=>String(a.id)===String(r));t&&$(t)},[g,n,S.state]);const J=()=>{const r=R.current;r&&(r.scrollTop=r.scrollHeight)};l.useEffect(()=>{J()},[y]);const X=async r=>{E(!0),u(null);try{const{data:t}=await x.get(`/bookings/${r}/chat`),a=t.data?.data||t.data?.messages||[];j(a),a.forEach(i=>{!i.read_at&&i.sender_id!==h.current&&P(i.id)})}catch(t){console.error("Failed to load messages:",t),u("Failed to load messages"),j([])}finally{E(!1)}};l.useEffect(()=>{if(!n?.id||!m.current)return;const r=n.id,t=`private-booking.${r}`;console.log("[ECHO] subscribing to:",t);const a=m.current.connector.pusher,i=a.subscribe(t);i.bind("pusher:subscription_succeeded",()=>{console.log("[PUSHER] ✅ subscription_succeeded:",t)}),i.bind("pusher:subscription_error",p=>{console.error("[PUSHER] ❌ subscription_error:",t,"status:",p),console.error("-> If status=403, your /broadcasting/auth or channels.php auth is rejecting the user.")});const c=m.current.private(`booking.${r}`),f=p=>{const b=K(p);j(C=>C.some(W=>String(W.id)===String(b.id))?C:[...C,b]),b.sender_id&&b.sender_id!==h.current&&P(r,b.id)};return c.listen(".message.sent",f),c.listen("message.sent",f),c.listen(".message.read",p=>console.log("[ECHO] message.read:",p)),X(r),()=>{console.log("[ECHO] leaving:",t),m.current?.leave(`booking.${r}`),a.unsubscribe(t)}},[n?.id]);const B=async r=>{if(r.preventDefault(),!w.trim()||!n)return;const t=w.trim();k("");try{const{data:a}=await x.post(`/bookings/${n.id}/chat`,{booking_id:n.id,message:t});a.data&&j(i=>[...i,a.data])}catch(a){console.error("Failed to send message:",a),u("Failed to send message"),k(t)}},P=async r=>{try{await x.post(`/bookings/${n?.id}/chat/mark-read`,{message_id:r})}catch(t){console.error("Failed to mark message as read:",t)}},T=async()=>{try{if(!g?.length)return;const r=await Promise.all(g.map(async a=>{try{const{data:i}=await x.get(`/bookings/${a.id}/chat/unread-count`),c=i?.data?.unread_count??i?.data??i?.unread_count??0;return{id:a.id,count:Number(c)||0}}catch(i){return console.error(`Failed unread count for booking ${a.id}:`,i),{id:a.id,count:0}}})),t=Object.fromEntries(r.map(a=>[a.id,a.count]));v(a=>a.map(i=>({...i,unread_count:t[i.id]??0})))}catch(r){console.error("Failed to fetch unread counts:",r)}};l.useEffect(()=>{if(d){T();const r=setInterval(T,1e4);return()=>clearInterval(r)}},[d]),l.useRef(null);const Y=r=>{if(!r)return"";const t=new Date(r);if(Number.isNaN(t.getTime()))return"";const i=Math.floor((new Date-t)/6e4);if(i<1)return"Just now";if(i<60)return`${i}m ago`;const c=Math.floor(i/60);if(c<24)return`${c}h ago`;const f=Math.floor(c/24);return f<7?`${f}d ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric"})},V=r=>{if(!r)return"";const t=new Date(r);return Number.isNaN(t.getTime())?"":t.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},I=g.filter(r=>{if(!_)return!0;const t=_.toLowerCase(),a=`${r.client?.first_name||""} ${r.client?.last_name||""}`.toLowerCase(),i=`${r.car?.make||""} ${r.car?.model||""}`.toLowerCase();return a.includes(t)||i.includes(t)});return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50 dark:from-black dark:via-gray-900 dark:to-gray-950 pt-20",children:e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsx(o.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl flex items-center justify-center shadow-lg",style:{background:`linear-gradient(135deg, ${s.teal}, ${s.darkBlue})`},children:e.jsx(N,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-clip-text text-transparent",style:{backgroundImage:`linear-gradient(135deg, ${s.darkBlue}, ${s.teal}, ${s.limeGreen})`},children:"Booking Messages"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Stay connected with your clients"})]})]})}),e.jsx(M,{children:H&&e.jsx(o.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"mb-4 p-4 rounded-xl border-2",style:{background:"rgba(220, 38, 38, 0.1)",borderColor:"#DC2626"},children:e.jsxs("p",{className:"text-red-800 dark:text-red-200 flex items-center gap-2",children:[e.jsx(ee,{className:"w-5 h-5"}),H]})})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-180px)]",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-200 dark:border-gray-700",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:_,onChange:r=>G(r.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 dark:text-white text-sm",style:{focusRing:s.teal}})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:L?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-t-transparent",style:{borderColor:s.tealDim,borderTopColor:"transparent"}})}):I.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-gray-400",children:[e.jsx(N,{className:"w-16 h-16 mb-3",style:{color:s.teal,opacity:.3}}),e.jsx("p",{className:"text-center font-medium",children:"No bookings found"}),e.jsx("p",{className:"text-xs text-center mt-1",children:"Try adjusting your search"})]}):I.map(r=>e.jsx(o.div,{whileHover:{x:5},onClick:()=>$(r),className:`p-4 border-b border-gray-200 dark:border-gray-700 cursor-pointer transition-all ${n?.id===r.id?"border-l-4":"hover:bg-gray-50 dark:hover:bg-gray-700"}`,style:n?.id===r.id?{background:s.tealDim,borderLeftColor:s.teal}:{},children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:r.client?.profile_picture?`/api/storage/${r.client.profile_picture}`:"/default-avatar.png",alt:r.client?.first_name||"Client",className:"w-12 h-12 rounded-full object-cover ring-2 ring-white dark:ring-gray-700"}),r.unread_count>0&&e.jsx(o.div,{animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0},className:"absolute -top-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center shadow-lg",style:{background:s.limeGreen},children:e.jsx("span",{className:"text-xs text-white font-bold",children:r.unread_count})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-white truncate flex items-center gap-1",children:[r.client?.first_name||"N/A"," ",r.client?.last_name||"",r.client?.verified_by_admin&&e.jsx(U,{className:"w-3 h-3",style:{color:s.teal}})]}),r.unread_count>0&&e.jsx(ce,{className:"w-4 h-4",style:{color:s.teal}})]}),e.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400 truncate flex items-center gap-1",children:[e.jsx(A,{className:"w-3 h-3"}),r.car?.make||"N/A"," ",r.car?.model||""]})]})]})},r.id))})]}),e.jsx("div",{className:"lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-200 dark:border-gray-700",children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 text-white relative overflow-hidden",style:{background:`linear-gradient(135deg, ${s.darkBlue}, ${s.teal}, ${s.limeGreen})`},children:[e.jsx("div",{className:"absolute top-0 right-0 w-48 h-48 bg-white/10 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-32 h-32 bg-white/10 rounded-full blur-2xl"}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:n.client?.profile_picture?`/api/storage/${n.client.profile_picture}`:"/default-avatar.png",alt:n.client?.first_name||"Client",className:"w-12 h-12 rounded-full object-cover border-2 border-white shadow-lg"}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-bold flex items-center gap-2",children:[n.client?.first_name||"N/A"," ",n.client?.last_name||"",n.client?.verified_by_admin&&e.jsx(U,{className:"w-4 h-4"})]}),e.jsxs("p",{className:"text-xs opacity-90",children:["@",n.client?.username||"unknown"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[n.client?.phone_number&&e.jsx(o.a,{whileHover:{scale:1.1},whileTap:{scale:.9},href:`tel:${n.client.phone_number}`,className:"p-2 bg-white/20 backdrop-blur-sm rounded-xl hover:bg-white/30 transition-colors",children:e.jsx(re,{className:"w-4 h-4"})}),n.client?.email&&e.jsx(o.a,{whileHover:{scale:1.1},whileTap:{scale:.9},href:`mailto:${n.client.email}`,className:"p-2 bg-white/20 backdrop-blur-sm rounded-xl hover:bg-white/30 transition-colors",children:e.jsx(te,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"p-3 bg-white/10 backdrop-blur-sm rounded-xl",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4"}),e.jsxs("span",{className:"truncate",children:[n.car?.make||"N/A"," ",n.car?.model||""]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate",children:n.start_datetime?V(n.start_datetime):"N/A"})]})]})})]})]}),e.jsxs("div",{ref:R,className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-gray-50/50 to-white dark:from-gray-900/50 dark:to-gray-800",style:{maxHeight:"calc(100vh - 450px)"},children:[F?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-t-transparent",style:{borderColor:s.tealDim,borderTopColor:"transparent"}})}):y.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx("div",{className:"w-20 h-20 rounded-full flex items-center justify-center mb-4",style:{background:s.tealDim},children:e.jsx(N,{className:"w-10 h-10",style:{color:s.teal}})}),e.jsx("p",{className:"text-lg font-medium",children:"No messages yet"}),e.jsx("p",{className:"text-sm",children:"Start the conversation!"})]}):e.jsxs(e.Fragment,{children:[y.map((r,t)=>{const a=r.sender_id===h.current||r.sender?.id===h.current,i=t===0||y[t-1].sender_id!==r.sender_id;return e.jsxs(o.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`flex items-end gap-2 ${a?"justify-end":"justify-start"}`,children:[!a&&i&&e.jsx("img",{src:r.sender?.profile_picture?`/api/storage/${r.sender.profile_picture}`:"/default-avatar.png",alt:r.sender?.first_name||"User",className:"w-8 h-8 rounded-full object-cover ring-2 ring-white dark:ring-gray-700"}),!a&&!i&&e.jsx("div",{className:"w-8"}),e.jsxs("div",{className:`flex flex-col ${a?"items-end":"items-start"} max-w-[70%]`,children:[e.jsx(o.div,{whileHover:{scale:1.02},className:`rounded-2xl px-4 py-2 shadow-md ${a?"text-white rounded-br-none":"bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-bl-none border border-gray-200 dark:border-gray-600"}`,style:a?{background:`linear-gradient(135deg, ${s.teal}, ${s.darkBlue})`}:{},children:e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words leading-relaxed",children:r.message})}),e.jsxs("div",{className:"flex items-center gap-1 mt-1 px-1",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:Y(r.created_at)}),a&&e.jsx("span",{children:r.read_at?e.jsx(de,{className:"w-3 h-3",style:{color:s.teal}}):e.jsx(ue,{className:"w-3 h-3 text-gray-400"})})]})]}),a&&i&&e.jsx("img",{src:r.sender?.profile_picture?`/api/storage/${r.sender.profile_picture}`:"/default-avatar.png",alt:r.sender?.first_name||"You",className:"w-8 h-8 rounded-full object-cover ring-2 ring-white dark:ring-gray-700"}),a&&!i&&e.jsx("div",{className:"w-8"})]},r.id)}),e.jsx("div",{ref:z})]}),e.jsx(M,{children:O&&e.jsxs(o.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"flex items-center gap-2",children:[e.jsx("img",{src:n.client?.profile_picture?`/api/storage/${n.client.profile_picture}`:"/default-avatar.png",alt:n.client?.first_name||"Client",className:"w-8 h-8 rounded-full object-cover ring-2 ring-white dark:ring-gray-700"}),e.jsx("div",{className:"bg-white dark:bg-gray-700 rounded-2xl rounded-bl-none px-4 py-3 border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full animate-bounce",style:{background:s.teal,animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 rounded-full animate-bounce",style:{background:s.darkBlue,animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 rounded-full animate-bounce",style:{background:s.limeGreen,animationDelay:"300ms"}})]})})]})})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",children:e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(o.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>console.log("Attach file"),className:"p-2 rounded-xl transition-colors",style:{background:s.tealDim,color:s.teal},children:e.jsx(ie,{className:"w-5 h-5"})}),e.jsx(o.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>console.log("Send emoji"),className:"p-2 rounded-xl transition-colors",style:{background:s.limeGreenDim,color:s.limeGreen},children:e.jsx(le,{className:"w-5 h-5"})}),e.jsx("div",{className:"flex-1 relative",children:e.jsx("textarea",{value:w,onChange:r=>{k(r.target.value)},onKeyPress:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),B(r))},placeholder:"Type your message...",rows:1,className:"w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 dark:bg-gray-700 dark:text-white resize-none",style:{focusRing:s.teal}})}),e.jsx(o.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:B,disabled:!w.trim(),className:"p-3 rounded-xl text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl",style:{background:`linear-gradient(135deg, ${s.teal}, ${s.darkBlue})`},children:e.jsx(me,{className:"w-5 h-5"})})]})})]}):e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center",children:e.jsxs(o.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 rounded-full flex items-center justify-center mb-6 mx-auto",style:{background:`linear-gradient(135deg, ${s.tealDim}, ${s.limeGreenDim})`},children:e.jsx(N,{className:"w-12 h-12",style:{color:s.teal}})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Select a Booking"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Choose a conversation to start chatting"})]})})})]})]})})}export{Ce as BookingChatSystem};
