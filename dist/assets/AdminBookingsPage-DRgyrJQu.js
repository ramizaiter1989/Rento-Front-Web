import{d as fe,r as l,j as e,B as v,b as S,t as R}from"./index-DbvXYXc0.js";import{T as _e,a as Ne,b as U,c as N,d as ve,e as j}from"./table-Cdzf11jr.js";import{I as C}from"./input-Bf8YvsU0.js";import{S as E,a as I,b as z,d as q,e as u}from"./select-895Ag1Vf.js";import{B as Z}from"./badge-De3gxj8m.js";import{D as G,b as J,c as K,d as Q,e as X}from"./dialog-CvL19ZOf.js";import{L as f}from"./label-DMFTECDG.js";import{C as ye}from"./card-6tZ6FSP9.js";import{R as ke}from"./refresh-cw-BkItMj0z.js";import{C as ee}from"./circle-check-CPW3N-42.js";import{T as Ae}from"./triangle-alert-y0xkyLH2.js";import{E as we}from"./eye--wIqRW1l.js";import{S as Ce}from"./square-pen-CxEXnCdu.js";import"./index-UZKPKpE4.js";import"./index-CB20-cGd.js";import"./Combination-B6rQ859v.js";import"./index-9AnY3iUi.js";import"./index-DXYwaiuf.js";import"./index-D66kppzp.js";import"./index-ddclwrTJ.js";import"./index-P5EQzgSd.js";import"./check-nqnuVgMJ.js";import"./index-AD6gynWr.js";import"./index-DE3TGyh9.js";const $e=[["path",{d:"M5 12h14",key:"1ays0h"}]],be=fe("minus",$e),Se={pending:"bg-yellow-100 text-yellow-700",confirmed:"bg-green-100 text-green-700",cancelled:"bg-red-100 text-red-700",completed:"bg-blue-100 text-blue-700",rejected:"bg-gray-200 text-gray-700"};function Be(t,o=14){return t?t.length>o?`${t.slice(0,o)}...`:t:"N/A"}function ct(){const[t,o]=l.useState([]),[x,d]=l.useState({}),[m,i]=l.useState(!1),[y,k]=l.useState(""),[A,w]=l.useState([]),[h,M]=l.useState("newest"),[_,$]=l.useState("all"),[B,O]=l.useState(!1),[Ie,ze]=l.useState(null),[ne,D]=l.useState(!1),[n,p]=l.useState(null),[F,H]=l.useState(null),[ie,T]=l.useState(!1),[re,W]=l.useState(""),L=async()=>{i(!0);try{const a={page:1,per_page:50},{data:s}=await S.get("/admin/bookings",{params:a}),r=s.bookings?.data||[];o(r),r.forEach(c=>{x[c.client_id]||le(c.client_id)})}catch(a){console.error(a)}finally{i(!1)}},le=async a=>{try{const{data:s}=await S.get(`/admin/users/${a}`),r=s.user?.first_name&&s.user?.last_name?`${s.user.first_name} ${s.user.last_name}`:s.user?.username||`User #${a}`;d(c=>({...c,[a]:r}))}catch{d(s=>({...s,[a]:`User #${a}`}))}};l.useEffect(()=>{L()},[]);const Y=async a=>{try{const{data:s}=await S.get(`/admin/bookings/${a}`);return s.booking??s.data??s}catch{return R({title:"Error",description:"Failed to fetch booking details",variant:"destructive"}),null}},b=l.useMemo(()=>{let a=[...t];if(y){const s=y.toLowerCase().trim();a=a.filter(r=>{const c=(x[r.client_id]??"").toLowerCase(),g=(r.car?.make??"").toLowerCase(),P=(r.car?.model??"").toLowerCase(),pe=`${g} ${P}`.trim(),je=(r.car?.agent?.username??"").toLowerCase();return[r.id,r.client_id,r.car_id,c,g,P,pe,je].join(" ").toLowerCase().includes(s)})}return A.length>0&&(a=a.filter(s=>A.includes(s.booking_request_status))),_!=="all"&&(a=a.filter(s=>(s.payment_status??"").toLowerCase()===_)),a.sort((s,r)=>{if(h==="newest"){const c=new Date(s.created_at??0).getTime(),g=new Date(r.created_at??0).getTime();return g!==c?g-c:Number(r.id)-Number(s.id)}if(h==="client_az"||h==="client_za"){const c=(x[s.client_id]??"").toLowerCase(),g=(x[r.client_id]??"").toLowerCase();return c<g?h==="client_az"?-1:1:c>g?h==="client_az"?1:-1:Number(r.id)-Number(s.id)}return h==="total_high"?Number(r.total_booking_price||0)-Number(s.total_booking_price||0):h==="total_low"?Number(s.total_booking_price||0)-Number(r.total_booking_price||0):0}),a},[t,y,x,A,_,h]),oe=l.useMemo(()=>b.reduce((a,s)=>a+Number(s.total_booking_price||0),0),[b]),ce=l.useMemo(()=>{const a={pending:0,confirmed:0,cancelled:0,completed:0,rejected:0};for(const s of t){const r=(s.booking_request_status??"").toLowerCase();a[r]!==void 0&&(a[r]+=1)}return a},[t]),de=a=>{p({...a}),D(!0)},me=async()=>{try{const a={booking_request_status:n.booking_request_status,payment_status:n.payment_status,payment_method:n.payment_method,total_booking_price:n.total_booking_price,extra_charge:n.extra_charge,with_driver:n.with_driver,is_delivered:n.is_delivered,start_datetime:n.start_datetime,end_datetime:n.end_datetime,pickup_location:n.pickup_location,dropoff_location:n.dropoff_location,reason_of_booking:n.reason_of_booking};await S.put(`/admin/bookings/${n.id}`,a),R.success("Booking updated successfully"),D(!1),L()}catch{R.error("Failed to update booking")}},ue=async a=>{await S.post(`/admin/bookings/${a}/force-complete`),L()},xe="/avatar.png",he="https://rento-lb.com/api/storage/",ge=a=>{const s=a?.client.profile_picture;if(!s)return xe;if(s.startsWith("http"))return s;const r=s.startsWith("/")?s.slice(1):s;return he+r};return e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Bookings"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"px-3 py-1.5 rounded-lg border bg-muted text-sm font-semibold",children:[e.jsxs("p",{children:["Total Bookings : ",b.length," "]}),e.jsxs("p",{children:["Total : $",oe.toLocaleString()]})]}),e.jsx(C,{placeholder:"Search client / car / agent  ",className:"h-8 w-44 text-xs",value:y,onChange:a=>k(a.target.value)}),e.jsxs(ye,{className:"p-3",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Status"}),e.jsx("div",{className:"flex flex-wrap gap-4",children:["pending","confirmed","cancelled","completed","rejected"].map(a=>{const s=A.includes(a);return e.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:s,onChange:r=>{const c=r.target.checked;w(g=>c?[...g,a]:g.filter(P=>P!==a))}}),e.jsxs("span",{className:"capitalize flex items-center gap-2",children:[a,e.jsx("span",{className:"inline-flex items-center justify-center h-5 min-w-6 px-2 rounded-full text-[11px] font-semibold bg-muted text-foreground",children:ce?.[a]??0})]})]},a)})}),A.length>0&&e.jsx("button",{type:"button",className:"mt-2 text-xs text-muted-foreground underline",onClick:()=>w([]),children:"Clear status filter"})]}),e.jsx("div",{className:"w-44",children:e.jsxs(E,{value:_,onValueChange:$,children:[e.jsx(I,{className:"h-8 text-xs",children:e.jsx(z,{placeholder:"Payment status"})}),e.jsxs(q,{children:[e.jsx(u,{value:"all",children:"All Payments"}),e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"paid",children:"Paid"})]})]})}),e.jsx("div",{className:"w-44",children:e.jsxs(E,{value:h,onValueChange:M,children:[e.jsx(I,{className:"h-8 text-xs",children:e.jsx(z,{placeholder:"Sort by"})}),e.jsxs(q,{children:[e.jsx(u,{value:"newest",children:"Newest"}),e.jsx(u,{value:"client_az",children:"Client A - Z"}),e.jsx(u,{value:"client_za",children:"Client Z - A"}),e.jsx(u,{value:"total_high",children:"Total High → Low"}),e.jsx(u,{value:"total_low",children:"Total Low → High"})]})]})}),e.jsx(v,{size:"icon",variant:"ghost","aria-label":"Refresh",onClick:L,children:e.jsx(ke,{size:16})})]})]}),e.jsx("div",{className:"rounded-xl border",children:e.jsxs(_e,{children:[e.jsx(Ne,{children:e.jsxs(U,{children:[e.jsx(N,{children:"ID"}),e.jsx(N,{children:"Client"}),e.jsx(N,{children:"Car"}),e.jsx(N,{children:"Agent"}),e.jsx(N,{children:"Status"}),e.jsx(N,{children:"Payment"}),e.jsx(N,{children:"Total"}),e.jsx(N,{className:"text-right",children:"Actions"})]})}),e.jsxs(ve,{children:[b.map(a=>e.jsxs(U,{children:[e.jsx(j,{children:e.jsxs("span",{className:"item-name-hover inline-flex items-center gap-2 cursor-pointer",title:Le(a),onClick:()=>te(a.id,Y,H,W,T),children:[a.id," "]})}),e.jsx(j,{children:e.jsxs("span",{className:"item-name-hover inline-flex items-center gap-2 cursor-pointer",title:De(a),children:[e.jsx("img",{src:ge(a),alt:a.client.username||"User",className:"h-7 w-7 rounded-full object-cover",onError:s=>{s.currentTarget.onerror=null,s.currentTarget.src="/avatar.png"}}),Be(x[a.client_id]||`User #${a.client_id}`,14)]})}),e.jsx(j,{children:e.jsx("span",{className:"item-name-hover inline-flex items-center gap-2 cursor-pointer",title:Te(a),children:a.car?`${a.car.make} ${a.car.model}`:`#${a.car_id}`})}),e.jsx(j,{children:e.jsx("span",{className:"item-name-hover inline-flex items-center gap-2 cursor-pointer",title:Pe(a),children:a.car?.agent?.username??"—"})}),e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:Se[a.booking_request_status],children:a.booking_request_status}),a.booking_request_status==="confirmed"?e.jsx(ee,{className:"w-4 h-4 text-green-600"}):e.jsx(Ae,{className:"w-4 h-4 text-red-500"})]}),e.jsx(j,{children:e.jsx(Z,{variant:a.payment_status==="paid"?"default":"secondary",children:a.payment_status})}),e.jsxs(j,{children:["$",a.total_booking_price]}),e.jsxs(j,{className:"flex justify-end gap-1",children:[e.jsx(v,{size:"icon",variant:"ghost","aria-label":"View",onClick:()=>te(a.id,Y,H,W,T),title:"View Details",children:e.jsx(we,{size:16})}),e.jsx(v,{size:"icon",variant:"ghost","aria-label":"Edit",onClick:()=>de(a),title:"Edit Details",children:e.jsx(Ce,{size:16})}),a.booking_request_status==="confirmed"?e.jsx(v,{size:"icon",variant:"ghost","aria-label":"Force complete",title:"Confirmed",onClick:()=>ue(a.id),children:e.jsx(ee,{size:16,className:"text-green-600"})}):e.jsx(v,{size:"icon",variant:"ghost","aria-label":"Disabled",disabled:!0,children:e.jsx(be,{size:16})})]})]},a.id)),!m&&b.length===0&&e.jsx(U,{children:e.jsx(j,{colSpan:7,className:"text-center py-10 text-muted-foreground",children:"No bookings found"})})]})]})}),e.jsx(G,{open:ie,onOpenChange:T,children:e.jsxs(J,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(K,{children:[e.jsx(Q,{children:"Booking Details"}),e.jsx(X,{children:"Complete booking information (read-only)."})]}),re==="view-booking"&&F&&e.jsx("div",{className:"space-y-6 text-sm",children:e.jsx(Ee,{booking:F,clients:x,onClose:()=>T(!1)})})]})}),e.jsx(G,{open:ne,onOpenChange:D,children:e.jsxs(J,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(K,{children:[e.jsx(Q,{children:"Edit Booking"}),e.jsx(X,{children:"All fields below are editable"})]}),n&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(f,{children:"Status"}),e.jsxs(E,{value:n.booking_request_status,onValueChange:a=>p({...n,booking_request_status:a}),children:[e.jsx(I,{children:e.jsx(z,{})}),e.jsx(q,{children:["pending","confirmed","cancelled","completed","rejected"].map(a=>e.jsx(u,{value:a,children:a},a))})]})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Payment Status"}),e.jsxs(E,{value:n.payment_status,onValueChange:a=>p({...n,payment_status:a}),children:[e.jsx(I,{children:e.jsx(z,{})}),e.jsxs(q,{children:[e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"paid",children:"Paid"}),e.jsx(u,{value:"failed",children:"Failed"})]})]})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Total Price"}),e.jsx(C,{type:"number",value:n.total_booking_price,onChange:a=>p({...n,total_booking_price:a.target.value})})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Extra Charge"}),e.jsx(C,{type:"number",value:n.extra_charge||0,onChange:a=>p({...n,extra_charge:a.target.value})})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Pickup Location"}),e.jsx(C,{value:n.pickup_location||"",onChange:a=>p({...n,pickup_location:a.target.value})})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Dropoff Location"}),e.jsx(C,{value:n.dropoff_location||"",onChange:a=>p({...n,dropoff_location:a.target.value})})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Start"}),e.jsx(C,{type:"datetime-local",value:n.start_datetime?.slice(0,16),onChange:a=>p({...n,start_datetime:a.target.value})})]}),e.jsxs("div",{children:[e.jsx(f,{children:"End"}),e.jsx(C,{type:"datetime-local",value:n.end_datetime?.slice(0,16),onChange:a=>p({...n,end_datetime:a.target.value})})]})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Reason / Notes"}),e.jsx("textarea",{className:"w-full border rounded-md p-2",rows:3,value:n.reason_of_booking||"",onChange:a=>p({...n,reason_of_booking:a.target.value})})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(v,{variant:"outline",onClick:()=>D(!1),children:"Cancel"}),e.jsx(v,{onClick:me,children:"Save Changes"})]})]})]})})]})}async function te(t,o,x,d,m){const i=await o(t);i&&(x(i),d("view-booking"),m(!0))}function De(t){return t?[`User ID : ${t.client.id??"N/A"}`,`username : ${t.client.username??"N/A"}`,`Phone Number : ${t.client.phone_number??"N/A"}`,`Email : ${t.client.email??"N/A"}`,`verified By Admin : ${t.client.verified_by_admin??"N/A"}`,`Gender : ${t.client.gender??"N/A"}`,`Birth Date : ${se(t.client.birth_date??"N/A")}`,`city : ${t.client.city??"N/A"}`,`bio : ${t.client.bio??"N/A"}`].join(`
`):""}function Te(t){return t?[`Car ID : ${t.car.id??"N/A"}`,`Agent ID : ${t.car.agent_id??"N/A"}`,`Year : ${t.car.year??"N/A"}`,`Cylinder Number : ${t.car.cylinder_number??"N/A"}`,`License Plate : ${t.car.license_plate??"N/A"}`,`Color : ${t.car.color??"N/A"}`,`Mileage : ${t.car.mileage??"N/A"}`,`Transmission : ${t.car.transmission??"N/A"}`,`Wheels Drive : ${t.car.wheels_drive??"N/A"}`,`Category : ${t.car.car_category??"N/A"}`,`Seats : ${t.car.seats??"N/A"}`,`Doors : ${t.car.doors??"N/A"}`,`Daily_rate : ${t.car.daily_rate??"N/A"}`,`hHliday Rate : ${t.car.holiday_rate??"N/A"}`,`Status : ${t.car.status??"N/A"}`].join(`
`):""}function Le(t){return t?[`Client Id : ${t.client_id??"N/A"}`,`Car Id : ${t.car_id??"N/A"}`,`Reason Of Booking : ${t.reason_of_booking??"N/A"}`,`Total Booking Price : ${t.total_booking_price??"N/A"}`,`Is Paid Online : ${t.is_paid_online??"N/A"}`,`Is Delivered : ${t.is_delivered??"N/A"}`,`Pickup Location : ${t.pickup_location??"N/A"}`,`Dropoff Location : ${t.dropoff_location??"N/A"}`].join(`
`):""}function Pe(t){return t?[`ID : ${t.car?.agent?.id??"N/A"}`,`Username : ${t.car?.agent?.username??"N/A"}`,`First Name : ${t.car?.agent?.first_name??"N/A"}`,`Last Name : ${t.car?.agent?.last_name??"N/A"}`,`Real User Id : ${t.car?.agent?.real_user_id??"N/A"}`,`Email : ${t.car?.agent?.email??"N/A"}`,`Verified_by_admin : ${t.car?.agent?.verified_by_admin??"N/A"}`,`Gender : ${t.car?.agent?.gender??"N/A"}`,`Birth date : ${se(t.car?.agent?.birth_date??"N/A")}`,`City : ${t.car?.agent?.city??"N/A"}`,`Bio : ${t.car?.agent?.bio??"N/A"}`].join(`
`):""}function ae(t){if(!t)return"N/A";const o=new Date(t);return Number.isNaN(o.getTime())?String(t):o.toLocaleString("en-US",{timeZone:"Asia/Beirut",month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0})}function se(t){if(!t)return"N/A";const o=new Date(t);return Number.isNaN(o.getTime())?String(t):o.toLocaleString("en-US",{timeZone:"Asia/Beirut",month:"numeric",day:"numeric",year:"numeric"})}function V(t){if(t==null||t==="")return"N/A";const o=Number(t);return Number.isNaN(o)?String(t):`$${o.toLocaleString("en-US")}`}function Ee({booking:t,clients:o,onClose:x}){const d=t?.client||{},m=t?.car||{};function i({label:_,value:$}){return e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[_," :"]}),e.jsx("span",{className:"text-foreground break-words",children:$??"N/A"})]})}const y=({label:_,value:$,tone:B="neutral"})=>{const O=B==="teal"?"bg-teal-600 text-white":B==="red"?"bg-red-600 text-white":B==="yellow"?"bg-yellow-500 text-white":"bg-muted text-foreground";return e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[e.jsx("span",{className:"text-muted-foreground",children:_}),e.jsx("span",{className:`inline-flex items-center justify-center px-2 h-5 rounded text-xs font-semibold leading-none ${O}`,children:$??"N/A"})]})},k=t?.booking_request_status??"N/A",A=k==="completed"?"teal":k==="pending"?"yellow":k==="cancelled"||k==="rejected"?"red":"neutral",w=t?.payment_status??"N/A",h=w==="paid"?"teal":w==="pending"?"yellow":w==="failed"?"red":"neutral",M=(d?.first_name&&d?.last_name?`${d.first_name} ${d.last_name}`:d?.username)||o?.[t?.client_id]||`User #${t?.client_id??"N/A"}`;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Booking"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-10 gap-y-3",children:[e.jsx(i,{label:"Booking ID",value:t?.id}),e.jsx(i,{label:"Car ID",value:t?.car_id??m?.id}),e.jsx(i,{label:"Start",value:ae(t?.start_datetime)}),e.jsx(i,{label:"End",value:ae(t?.end_datetime)}),e.jsx("div",{className:"flex flex-wrap items-center gap-8 pt-1",children:e.jsx(y,{label:"Status:",value:k,tone:A})}),e.jsx("div",{className:"flex flex-wrap items-center gap-8 pt-1",children:e.jsx(y,{label:"Payment:",value:w,tone:h})}),e.jsx(i,{label:"Total",value:V(t?.total_booking_price)}),e.jsx(i,{label:"Extra Charge",value:V(t?.extra_charge??0)}),e.jsx(i,{label:"Deposit",value:V(t?.deposit??0)}),e.jsx(i,{label:"Paid Online",value:t?.is_paid_online?"Yes":"No"}),e.jsx(i,{label:"Payment Method",value:t?.payment_method??"N/A"}),e.jsx(i,{label:"With Driver",value:t?.with_driver?"Yes":"No"})]}),e.jsx("div",{className:"border-t pt-3"}),e.jsx("div",{className:"text-sm font-semibold",children:"Client"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-10 gap-y-3",children:[e.jsx(i,{label:"Client Name",value:M}),e.jsx(i,{label:"Client ID",value:t?.client_id??d?.id}),e.jsx(i,{label:"Email",value:d?.email??"N/A"}),e.jsx(i,{label:"Phone",value:d?.phone_number??"N/A"})]}),e.jsx("div",{className:"border-t pt-3"}),t?.car&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm font-semibold",children:"Car"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-10 gap-y-3",children:[e.jsx(i,{label:"Make",value:m?.make}),e.jsx(i,{label:"Model",value:m?.model}),e.jsx(i,{label:"Year",value:m?.year}),e.jsx(i,{label:"Plate",value:m?.license_plate}),e.jsx(i,{label:"Color",value:m?.color}),e.jsx(i,{label:"Transmission",value:m?.transmission}),e.jsx(i,{label:"Fuel",value:m?.fuel_type})]}),e.jsx("div",{className:"border-t pt-3"})]}),e.jsx("div",{className:"text-sm font-semibold",children:"Locations"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-10 gap-y-3",children:[e.jsx(i,{label:"Pickup",value:t?.pickup_location??"N/A"}),e.jsx(i,{label:"Dropoff",value:t?.dropoff_location??"N/A"}),e.jsx(i,{label:"Delivery Address",value:t?.delivery_location?.address??"N/A"}),e.jsx(i,{label:"Return Address",value:t?.return_location?.address??"N/A"})]}),t?.reason_of_booking&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t pt-3"}),e.jsx("div",{className:"text-sm font-semibold",children:"Reason / Notes"}),e.jsx("div",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t?.reason_of_booking})]}),e.jsx("div",{className:"pt-3 flex gap-2 justify-end",children:e.jsx(v,{variant:"outline",className:"w-28",onClick:x,children:"Close"})})]})}export{ct as default,te as openBookingView};
