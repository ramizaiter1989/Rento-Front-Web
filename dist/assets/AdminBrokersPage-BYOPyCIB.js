import{r as n,t as d,j as e,B as l}from"./index-DbvXYXc0.js";import{b as pe,a as fe,I as ge,g as X,J as ye,G as Ce,H as ve,K as ke,L as be,M as _e}from"./adminApi-C-vdNBvN.js";import{C as p,b as U,c as $,a as f}from"./card-6tZ6FSP9.js";import{B as Y}from"./badge-De3gxj8m.js";import{T as C,a as v,b as c,c as t,d as k,e as r}from"./table-Cdzf11jr.js";import{D as Z,b as ee,c as se,d as ae}from"./dialog-CvL19ZOf.js";import{I as B}from"./input-Bf8YvsU0.js";import{L as b}from"./label-DMFTECDG.js";import{T as Ne,a as we,b as A,c as D}from"./tabs-C3_ONro2.js";import{A as Be,a as Ae,b as De,c as Se,d as Re,e as Te,f as Fe,g as Pe}from"./alert-dialog-iBykHA9-.js";import{U as re}from"./users-E8rCSFRH.js";import{D as te}from"./dollar-sign-o41FEJ1i.js";import{R as Le}from"./refresh-cw-BkItMj0z.js";import{C as Ue}from"./chevron-left-DlVhwfSE.js";import"./index-AD6gynWr.js";import"./index-UZKPKpE4.js";import"./index-9AnY3iUi.js";import"./Combination-B6rQ859v.js";import"./index-DE3TGyh9.js";import"./index-B1ZSOLeI.js";import"./index-CB20-cGd.js";function g(x){return x?.username||[x?.first_name,x?.last_name].filter(Boolean).join(" ")||`Broker #${x?.id}`}function ts(){const[x,I]=n.useState([]),[ne,z]=n.useState({data:[]}),[ie,H]=n.useState(!0),[o,M]=n.useState(null),[le,O]=n.useState("overview"),[u,E]=n.useState(null),[S,R]=n.useState({data:[],statistics:{}}),[oe,G]=n.useState({data:[]}),[ce,J]=n.useState([]),[K,de]=n.useState("all"),[_,T]=n.useState({open:!1,title:"",message:"",onConfirm:null}),[N,m]=n.useState({open:!1,type:null}),[i,h]=n.useState({username:"",phone_number:"",email:"",password:"",password_confirmation:"",first_name:"",last_name:"",broker_id:"",amount:"",reference:"",notes:""}),w=n.useCallback(async()=>{H(!0);try{const s=await pe({role:"broker",per_page:200}),a=s.data?.users?.data??s.data?.users??s.data?.data;I(Array.isArray(a)?a:[])}catch(s){console.error(s),d.error("Failed to load brokers"),I([])}finally{H(!1)}},[]),y=n.useCallback(async()=>{try{const s=await fe({per_page:100}),a=s.data?.data??s.data?.commissions??s.data;z({data:Array.isArray(a)?a:[]})}catch{z({data:[]})}},[]),F=n.useCallback(async s=>{if(M(s),O("overview"),!!s?.id)try{const[a,j,P,L]=await Promise.all([ge(s.id).catch(()=>({data:null})),X(s.id).catch(()=>({data:{data:[],statistics:{}}})),ye(s.id).catch(()=>({data:{payouts:{data:[]}}})),Ce(s.id).catch(()=>({data:{referrals:[]}}))]);E(a.data);const q=j.data?.commissions?.data??j.data?.commissions;R({data:Array.isArray(q)?q:[],statistics:j.data?.statistics||{}});const Q=P.data?.payouts?.data??P.data?.data??P.data;G({data:Array.isArray(Q)?Q:[]});const W=L.data?.referrals??L.data?.data??L.data;J(Array.isArray(W)?W:[])}catch{d.error("Failed to load broker detail")}},[]),me=()=>{M(null),E(null),R({data:[],statistics:{}}),G({data:[]}),J([])},V=async s=>{if(o?.id){de(s);try{const a=await X(o.id,{status:s==="all"?void 0:s}),j=a.data?.commissions?.data??a.data?.commissions;R({data:Array.isArray(j)?j:[],statistics:a.data?.statistics||{}})}catch(a){console.error(a)}}};n.useEffect(()=>{w(),y()},[w,y]);const xe=async()=>{try{await ve({username:i.username.trim(),phone_number:i.phone_number.trim(),email:i.email.trim()||void 0,password:i.password,password_confirmation:i.password_confirmation,first_name:i.first_name.trim(),last_name:i.last_name.trim()}),d.success("Broker created"),m({open:!1,type:null}),w()}catch(s){d.error(s.response?.data?.message||"Failed")}},he=async()=>{try{await ke({broker_id:parseInt(i.broker_id,10),amount:parseFloat(i.amount)*100,reference:i.reference.trim()||void 0,notes:i.notes.trim()||void 0}),d.success("Payout created"),m({open:!1,type:null}),o?.id&&F(o),y()}catch(s){d.error(s.response?.data?.message||"Payout failed")}},je=s=>{T({open:!0,title:"Cancel commission",message:"Are you sure?",onConfirm:async()=>{try{await be(s.id),d.success("Commission cancelled"),o?.id&&V(K),y()}catch(a){d.error(a.response?.data?.message||"Failed")}}})},ue=s=>{T({open:!0,title:"Delete referral",message:"Remove this referral?",onConfirm:async()=>{try{await _e(s.id),d.success("Referral deleted"),o?.id&&F(o)}catch(a){d.error(a.response?.data?.message||"Failed")}}})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Brokers"}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{variant:"outline",onClick:()=>{h({username:"",phone_number:"",email:"",password:"",password_confirmation:"",first_name:"",last_name:""}),m({open:!0,type:"create-broker"})},children:[e.jsx(re,{className:"w-4 h-4 mr-2"})," Create Broker"]}),e.jsxs(l,{onClick:()=>{h({broker_id:o?.id?String(o.id):"",amount:u?.balance!=null?String(u.balance):"",reference:"",notes:""}),m({open:!0,type:"create-payout"})},children:[e.jsx(te,{className:"w-4 h-4 mr-2"})," Create Payout"]})]}),e.jsx(l,{variant:"outline",size:"icon",onClick:()=>{w(),y()},"aria-label":"Refresh",children:e.jsx(Le,{className:"w-4 h-4"})})]}),o?e.jsxs(p,{children:[e.jsxs(U,{className:"flex flex-row items-center justify-between",children:[e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5"}),g(o)]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>{h({broker_id:String(o.id),amount:u?.balance?String(u.balance):"",reference:"",notes:""}),m({open:!0,type:"create-payout"})},children:[e.jsx(te,{className:"w-4 h-4 mr-1"})," Pay broker"]}),e.jsxs(l,{variant:"ghost",size:"sm",onClick:me,children:[e.jsx(Ue,{className:"w-4 h-4 mr-1"})," Close"]})]})]}),e.jsx(f,{children:e.jsxs(Ne,{value:le,onValueChange:O,children:[e.jsxs(we,{className:"grid w-full grid-cols-4",children:[e.jsx(A,{value:"overview",children:"Overview"}),e.jsx(A,{value:"commissions",children:"Commissions"}),e.jsx(A,{value:"payouts",children:"Payouts"}),e.jsx(A,{value:"referrals",children:"Referrals"})]}),e.jsx(D,{value:"overview",className:"space-y-4 mt-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(p,{children:e.jsxs(f,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Balance"}),e.jsxs("p",{className:"text-2xl font-bold text-primary",children:["$",(u?.balance??0).toFixed(2)]})]})}),e.jsx(p,{children:e.jsxs(f,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total commissions"}),e.jsxs("p",{className:"text-2xl font-bold",children:["$",(u?.total_commissions??S.statistics?.total_commissions??0).toFixed(2)]})]})}),e.jsx(p,{children:e.jsxs(f,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total payouts"}),e.jsxs("p",{className:"text-2xl font-bold",children:["$",(u?.total_payouts??S.statistics?.total_payouts??0).toFixed(2)]})]})})]})}),e.jsxs(D,{value:"commissions",className:"mt-4",children:[e.jsx("div",{className:"flex gap-2 mb-4",children:["all","pending","paid","cancelled"].map(s=>e.jsx(l,{variant:K===s?"default":"outline",size:"sm",onClick:()=>V(s),children:s.charAt(0).toUpperCase()+s.slice(1)},s))}),e.jsxs(C,{children:[e.jsx(v,{children:e.jsxs(c,{children:[e.jsx(t,{children:"ID"}),e.jsx(t,{children:"Referred user"}),e.jsx(t,{children:"Promo"}),e.jsx(t,{children:"Amount"}),e.jsx(t,{children:"Commission"}),e.jsx(t,{children:"Status"}),e.jsx(t,{children:"Actions"})]})}),e.jsx(k,{children:(S.data||[]).map(s=>e.jsxs(c,{children:[e.jsx(r,{children:s.id}),e.jsx(r,{children:s.referredUser?g(s.referredUser):s.referred_user_id}),e.jsx(r,{children:s.promoCode?.code||"—"}),e.jsxs(r,{children:["$",Number(s.booking_amount||0).toFixed(2)]}),e.jsxs(r,{children:["$",Number(s.commission_amount||0).toFixed(2)," (",s.commission_percentage,"%)"]}),e.jsx(r,{children:e.jsx(Y,{variant:s.status==="paid"?"default":s.status==="cancelled"?"secondary":"outline",children:s.status})}),e.jsx(r,{children:s.status==="pending"&&e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>je(s),children:"Cancel"})})]},s.id))})]})]}),e.jsx(D,{value:"payouts",className:"mt-4",children:e.jsxs(C,{children:[e.jsx(v,{children:e.jsxs(c,{children:[e.jsx(t,{children:"Reference"}),e.jsx(t,{children:"Amount"}),e.jsx(t,{children:"Paid at"}),e.jsx(t,{children:"Description"})]})}),e.jsx(k,{children:(oe.data||[]).map(s=>e.jsxs(c,{children:[e.jsx(r,{className:"font-mono text-xs",children:s.reference_id||s.id}),e.jsxs(r,{children:["$",((s.amount||0)/100).toFixed(2)]}),e.jsx(r,{children:s.paid_at?new Date(s.paid_at).toLocaleString():"—"}),e.jsx(r,{children:s.description||s.metadata?.reference||"—"})]},s.id))})]})}),e.jsx(D,{value:"referrals",className:"mt-4",children:e.jsxs(C,{children:[e.jsx(v,{children:e.jsxs(c,{children:[e.jsx(t,{children:"ID"}),e.jsx(t,{children:"Referred user"}),e.jsx(t,{children:"Promo"}),e.jsx(t,{children:"Actions"})]})}),e.jsx(k,{children:(ce||[]).map(s=>e.jsxs(c,{children:[e.jsx(r,{children:s.id}),e.jsx(r,{children:s.referredUser?g(s.referredUser):s.referred_user_id}),e.jsx(r,{children:s.promoCode?.code||"—"}),e.jsx(r,{children:e.jsx(l,{variant:"ghost",size:"sm",className:"text-destructive",onClick:()=>ue(s),children:"Delete"})})]},s.id))})]})})]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(p,{children:[e.jsxs(U,{children:[e.jsx($,{children:"Brokers"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Click Manage to view balance, commissions, payouts, and referrals."})]}),e.jsx(f,{className:"p-0",children:e.jsxs(C,{children:[e.jsx(v,{children:e.jsxs(c,{children:[e.jsx(t,{children:"ID"}),e.jsx(t,{children:"Username"}),e.jsx(t,{children:"Name"}),e.jsx(t,{children:"Phone"}),e.jsx(t,{children:"Actions"})]})}),e.jsx(k,{children:ie?e.jsx(c,{children:e.jsx(r,{colSpan:5,className:"text-center py-8",children:"Loading..."})}):x.length===0?e.jsx(c,{children:e.jsx(r,{colSpan:5,className:"text-center py-8 text-muted-foreground",children:"No brokers found"})}):x.map(s=>e.jsxs(c,{children:[e.jsx(r,{children:s.id}),e.jsx(r,{children:s.username}),e.jsx(r,{children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"—"}),e.jsx(r,{children:s.phone_number||"—"}),e.jsx(r,{children:e.jsx(l,{variant:"outline",size:"sm",onClick:()=>F(s),children:"Manage"})})]},s.id))})]})})]}),e.jsxs(p,{children:[e.jsx(U,{children:e.jsx($,{children:"All broker commissions"})}),e.jsx(f,{className:"p-0",children:e.jsxs(C,{children:[e.jsx(v,{children:e.jsxs(c,{children:[e.jsx(t,{children:"ID"}),e.jsx(t,{children:"Broker"}),e.jsx(t,{children:"Referred user"}),e.jsx(t,{children:"Promo"}),e.jsx(t,{children:"Amount"}),e.jsx(t,{children:"Status"})]})}),e.jsx(k,{children:(ne.data||[]).map(s=>e.jsxs(c,{children:[e.jsx(r,{children:s.id}),e.jsx(r,{children:s.broker?g(s.broker):s.broker_id}),e.jsx(r,{children:s.referredUser?g(s.referredUser):"—"}),e.jsx(r,{children:s.promoCode?.code||"—"}),e.jsxs(r,{children:["$",Number(s.commission_amount||0).toFixed(2)]}),e.jsx(r,{children:e.jsx(Y,{variant:s.status==="paid"?"default":s.status==="cancelled"?"secondary":"outline",children:s.status})})]},s.id))})]})})]})]}),e.jsx(Z,{open:N.open&&N.type==="create-broker",onOpenChange:s=>!s&&m({open:!1,type:null}),children:e.jsxs(ee,{className:"max-w-md",children:[e.jsx(se,{children:e.jsx(ae,{children:"Create Broker"})}),e.jsxs("div",{className:"space-y-4",children:[["username","first_name","last_name","phone_number","email","password","password_confirmation"].map(s=>e.jsxs("div",{children:[e.jsx(b,{children:s.replace(/_/g," ")}),e.jsx(B,{type:s.includes("password")?"password":"text",value:i[s],onChange:a=>h(j=>({...j,[s]:a.target.value}))})]},s)),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{variant:"outline",onClick:()=>m({open:!1,type:null}),children:"Cancel"}),e.jsx(l,{onClick:xe,children:"Create"})]})]})]})}),e.jsx(Z,{open:N.open&&N.type==="create-payout",onOpenChange:s=>!s&&m({open:!1,type:null}),children:e.jsxs(ee,{className:"max-w-md",children:[e.jsx(se,{children:e.jsx(ae,{children:"Create Payout"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(b,{children:"Broker"}),e.jsxs("select",{className:"w-full border rounded-md px-3 py-2",value:i.broker_id,onChange:s=>h(a=>({...a,broker_id:s.target.value})),children:[e.jsx("option",{value:"",children:"Select broker"}),x.map(s=>e.jsx("option",{value:s.id,children:g(s)},s.id))]})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Amount ($)"}),e.jsx(B,{type:"number",step:.01,value:i.amount,onChange:s=>h(a=>({...a,amount:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Reference (optional)"}),e.jsx(B,{value:i.reference,onChange:s=>h(a=>({...a,reference:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Notes (optional)"}),e.jsx(B,{value:i.notes,onChange:s=>h(a=>({...a,notes:s.target.value}))})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{variant:"outline",onClick:()=>m({open:!1,type:null}),children:"Cancel"}),e.jsx(l,{onClick:he,children:"Create Payout"})]})]})]})}),e.jsx(Be,{open:_.open,onOpenChange:s=>T(a=>({...a,open:s})),children:e.jsxs(Ae,{children:[e.jsxs(De,{children:[e.jsx(Se,{children:_.title}),e.jsx(Re,{children:_.message})]}),e.jsxs(Te,{children:[e.jsx(Fe,{children:"Cancel"}),e.jsx(Pe,{onClick:_.onConfirm,children:"Confirm"})]})]})})]})}export{ts as default};
