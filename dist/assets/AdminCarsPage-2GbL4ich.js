import{_ as ze,r as m,j as e,a as ve,B as _,R as ne,M as fe}from"./index-DbvXYXc0.js";import{c as Oe,Q as Be,R as be,S as $e,T as Ue,t as Ye,U as Ke}from"./adminApi-C-vdNBvN.js";import"./table-Cdzf11jr.js";import"./card-6tZ6FSP9.js";import{I as K}from"./input-Bf8YvsU0.js";import{S as I,a as T,b as V,d as z,e as h}from"./select-895Ag1Vf.js";import{B as E}from"./badge-De3gxj8m.js";import{D as je,b as _e,c as Ne,d as ye}from"./dialog-CvL19ZOf.js";import{u as ce}from"./use-toast-BTZLQfF-.js";import{S as Ge}from"./search-DsOkoVxz.js";import{E as qe}from"./eye--wIqRW1l.js";import{S as We}from"./square-pen-CxEXnCdu.js";import{T as He}from"./trash-2-DiSdLuQ2.js";import{C as Qe}from"./chevron-left-DlVhwfSE.js";import{C as Je}from"./chevron-right-DaEW3pZI.js";import{N as Xe}from"./navigation-CqPPssKH.js";import{B as Ze}from"./building-2-CRipOmJR.js";import"./index-UZKPKpE4.js";import"./index-CB20-cGd.js";import"./Combination-B6rQ859v.js";import"./index-9AnY3iUi.js";import"./index-DXYwaiuf.js";import"./index-D66kppzp.js";import"./index-ddclwrTJ.js";import"./index-P5EQzgSd.js";import"./check-nqnuVgMJ.js";import"./index-AD6gynWr.js";import"./index-DE3TGyh9.js";const le=20,ea=[{label:"Select region...",value:""},{label:"Beirut",value:"Beirut"},{label:"Mount Lebanon",value:"Mount Lebanon"},{label:"North",value:"North"},{label:"South",value:"South"},{label:"Bekaa",value:"Bekaa"},{label:"Baalbek",value:"Baalbek"},{label:"Keserwan",value:"Keserwan"},{label:"Nabatieh",value:"Nabatieh"},{label:"Akkar",value:"Akkar"}];function aa(s){if(!s||typeof s!="string")return null;const v=s.trim(),i=v.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);if(i)return{lat:parseFloat(i[1]),lng:parseFloat(i[2])};const o=v.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);if(o)return{lat:parseFloat(o[1]),lng:parseFloat(o[2])};const y=v.match(/(?:!3d|!4d|!1d)(-?\d+\.?\d*)/g);if(y&&y.length>=2){const b=parseFloat(y[0].replace(/\D/g,"")),j=parseFloat(y[1].replace(/\D/g,""));if(!isNaN(b)&&!isNaN(j))return{lat:b,lng:j}}return null}const sa=[{value:"all",label:"All Status"},{value:"available",label:"Available"},{value:"not_available",label:"Not Available"},{value:"rented",label:"Rented"},{value:"maintenance",label:"Maintenance"}],ta=[{value:"all",label:"All"},{value:"true",label:"Accepted"},{value:"false",label:"Not Accepted"}],la=[{value:"all",label:"All"},{value:"true",label:"Private"},{value:"false",label:"Public"}],za=()=>{const[s]=ze(),[v,i]=m.useState([]),[o,y]=m.useState({current_page:1,last_page:1,per_page:le,total:0}),[b,j]=m.useState(!0),[c,x]=m.useState(1),[l,S]=m.useState("all"),[g,k]=m.useState("all"),[D,G]=m.useState("all"),[t,d]=m.useState(""),[r,C]=m.useState([]),[w,O]=m.useState("");m.useEffect(()=>{const a=s.get("agent_id");a!=null&&a!==""&&d(a)},[s]),m.useEffect(()=>{(async()=>{try{const n=await Be({per_page:500,sort_by:"username",sort_order:"asc"}),A=(n.data?.agencies??n.data)?.data??[];C(Array.isArray(A)?A:[])}catch(n){console.error("Failed to load agencies for cars filter",n)}})()},[]);const[B,J]=m.useState([]),[X,de]=m.useState([]),[P,Ce]=m.useState("newest"),[we,Se]=m.useState(!1),[$,U]=m.useState(null),[ke,q]=m.useState(!1),[ue,W]=m.useState(""),{toast:L}=ce(),[Z,Y]=m.useState(null),[da,Ae]=m.useState({open:!1,title:"",message:"",onConfirm:null}),[ee,Le]=m.useState(""),[ae,Me]=m.useState(""),[se,Fe]=m.useState(""),[te,Re]=m.useState(""),re=m.useCallback(async()=>{j(!0);try{const a={per_page:le,page:c,...l&&l!=="all"&&{status:l},...g&&g!=="all"&&{car_accepted:g},...D&&D!=="all"&&{is_private:D},...t&&{agent_id:Number(t)}},n=await Oe(a),u=n.data||n,A=Array.isArray(u.cars)?u.cars:u.cars?.data??[],M=u.meta||u.cars&&{total:u.cars.total,current_page:u.cars.current_page??c,last_page:u.cars.last_page??1,per_page:u.cars.per_page??le}||o;i(A),y(p=>({...p,...M,total:M.total??p.total,current_page:M.current_page??c,last_page:M.last_page??p.last_page,per_page:M.per_page??le}))}catch(a){a.response?.status===403?L({title:"Access denied",description:"Super admin access required",variant:"destructive"}):a.response?.status===401?L({title:"Unauthorized",description:"Please log in again",variant:"destructive"}):(console.error("Failed to load cars",a),L({title:"Error",description:"Failed to load cars",variant:"destructive"}))}finally{j(!1)}},[c,l,g,D,t,w]);m.useEffect(()=>{re()},[re]);const me=async a=>{try{const n=await $e(a),u=n.data||n;return u?.car??u??null}catch(n){return n.response?.status===403?L({title:"Access denied",description:"Super admin access required",variant:"destructive"}):n.response?.status===404?L({title:"Full details unavailable",description:"Showing list data (GET /admin/cars/{id} returned 404).",variant:"destructive"}):L({title:"Error",description:"Failed to fetch car details",variant:"destructive"}),null}},Ee=a=>{U(a),W("view-car"),q(!0),me(a.id).then(n=>{n&&U(n)})},De=a=>{U(a),Y({...a}),W("edit-car"),q(!0),me(a.id).then(n=>{n&&(U(n),Y(u=>u&&u.id===n.id?{...n,...u}:{...n}))})},Pe="/car-avatar.png",Ie=m.useMemo(()=>`${"https://rento-lb.com/api/api".trim().replace(/\/+$/,"").replace(/\/api\/api\/?$/,"")}/api/storage/`,[]),ge=a=>{if(!a)return null;if(a.startsWith("http"))return a;const n=a.startsWith("/")?a.slice(1):a;return`${Ie}${n}`},ie=a=>ge(a)||Pe,Te=(a,n,u)=>{Ae({open:!0,title:a,message:n,onConfirm:u})},pe=async a=>{try{const n=await be(a.id,!0),u=n.data||n,A=u?.car??u??{...a,car_accepted:!0};i(M=>M.map(p=>p.id===a.id?{...p,car_accepted:!0}:p)),$?.id===a.id&&U(A),Z?.id===a.id&&Y(A),L({title:"Success",description:"Car accepted successfully"})}catch(n){n.response?.status===403?L({title:"Access denied",description:"Super admin access required",variant:"destructive"}):L({title:"Error",description:n.response?.data?.message||"Failed to accept car",variant:"destructive"})}},xe=async a=>{try{const n=await be(a.id,!1),u=n.data||n,A=u?.car??u??{...a,car_accepted:!1};i(M=>M.map(p=>p.id===a.id?{...p,car_accepted:!1}:p)),$?.id===a.id&&U(A),Z?.id===a.id&&Y(A),L({title:"Success",description:"Car rejected successfully"})}catch(n){n.response?.status===403?L({title:"Access denied",description:"Super admin access required",variant:"destructive"}):L({title:"Error",description:n.response?.data?.message||"Failed to reject car",variant:"destructive"})}},Ve=async a=>{try{await Ke(a),L({title:"Success",description:"Car deleted successfully"}),re(),q(!1)}catch{L({title:"Error",description:"Failed to delete car",variant:"destructive"})}},H=a=>{if(a==null||a==="")return NaN;if(typeof a=="number")return a;const n=String(a).replace(/[^0-9.]/g,""),u=Number(n);return Number.isNaN(u)?NaN:u},he=m.useMemo(()=>{let a=[...v];if(w&&w.trim()){const p=w.toLowerCase().trim();a=a.filter(N=>JSON.stringify(N).toLowerCase().includes(p))}if(B.length>0){const p=B.map(N=>String(N).toLowerCase());a=a.filter(N=>p.includes((N.car_category||"").toLowerCase()))}X.length>0&&(a=a.filter(p=>X.includes(p.status)));const n=ee?Number(ee):null,u=ae?Number(ae):null;(n!==null||u!==null)&&(a=a.filter(p=>{const N=Number(p.year);return!(Number.isNaN(N)||n!==null&&N<n||u!==null&&N>u)}));const A=se!==""?H(se):null,M=te!==""?H(te):null;return(A!==null||M!==null)&&(a=a.filter(p=>{const N=H(p.daily_rate);return!(Number.isNaN(N)||A!==null&&!Number.isNaN(A)&&N<A||M!==null&&!Number.isNaN(M)&&N>M)})),P==="newest"&&a.sort((p,N)=>new Date(N.created_at)-new Date(p.created_at)),P==="price"&&a.sort((p,N)=>{const F=H(p.daily_rate),R=H(N.daily_rate);return Number.isNaN(F)&&Number.isNaN(R)?0:Number.isNaN(F)?1:Number.isNaN(R)?-1:F-R}),(P==="year_asc"||P==="year_desc")&&a.sort((p,N)=>{const F=Number(p.year),R=Number(N.year);return Number.isNaN(F)&&Number.isNaN(R)?0:Number.isNaN(F)?1:Number.isNaN(R)?-1:P==="year_asc"?F-R:R-F}),(P==="views_asc"||P==="views_desc")&&a.sort((p,N)=>{const F=Number(p.views_count),R=Number(N.views_count);return Number.isNaN(F)&&Number.isNaN(R)?0:Number.isNaN(F)?1:Number.isNaN(R)?-1:P==="views_asc"?F-R:R-F}),a},[v,w,B,X,P,ee,ae,se,te]);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Cars"})}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"relative w-full sm:w-72",children:[e.jsx(Ge,{className:"absolute left-3 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(K,{placeholder:"Search make, model, plate, color...",className:"pl-9 h-9",value:w,onChange:a=>{O(a.target.value),x(1)}})]}),e.jsxs(I,{value:t||"all",onValueChange:a=>{d(a==="all"?"":a),x(1)},children:[e.jsx(T,{className:"h-9 w-[200px]",children:e.jsx(V,{placeholder:"Filter by agency"})}),e.jsxs(z,{children:[e.jsx(h,{value:"all",children:"All agencies"}),r.map(a=>e.jsx(h,{value:String(a.id),children:a.username||(a.first_name&&a.last_name?`${a.first_name} ${a.last_name}`:`Agency #${a.id}`)},a.id))]})]}),e.jsxs(I,{value:l,onValueChange:a=>{S(a),x(1)},children:[e.jsx(T,{className:"h-9 w-[140px]",children:e.jsx(V,{placeholder:"Status"})}),e.jsx(z,{children:sa.map(a=>e.jsx(h,{value:a.value,children:a.label},a.value))})]}),e.jsxs(I,{value:g,onValueChange:a=>{k(a),x(1)},children:[e.jsx(T,{className:"h-9 w-[130px]",children:e.jsx(V,{placeholder:"Accepted"})}),e.jsx(z,{children:ta.map(a=>e.jsx(h,{value:a.value,children:a.label},a.value))})]}),e.jsxs(I,{value:D,onValueChange:a=>{G(a),x(1)},children:[e.jsx(T,{className:"h-9 w-[110px]",children:e.jsx(V,{placeholder:"Visibility"})}),e.jsx(z,{children:la.map(a=>e.jsx(h,{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx("span",{className:"font-semibold text-foreground",children:o.total}),e.jsx("span",{children:"cars"})]}),e.jsx(_,{variant:"outline",size:"sm",onClick:()=>Se(a=>!a),children:"More filters"})]})]}),we&&e.jsx("div",{className:"mt-3 rounded-lg border bg-background p-3",children:e.jsxs("div",{className:"flex flex-wrap gap-3 items-end",children:[e.jsxs(I,{value:P,onValueChange:Ce,children:[e.jsx(T,{className:"h-9 w-[180px]",children:e.jsx(V,{placeholder:"Sort"})}),e.jsxs(z,{children:[e.jsx(h,{value:"newest",children:"Newest"}),e.jsx(h,{value:"price",children:"Price ↑"}),e.jsx(h,{value:"year_asc",children:"Year ↑"}),e.jsx(h,{value:"year_desc",children:"Year ↓"}),e.jsx(h,{value:"views_asc",children:"Views ↑"}),e.jsx(h,{value:"views_desc",children:"Views ↓"})]})]}),e.jsxs(I,{value:B[0]??"all",onValueChange:a=>J(a==="all"?[]:[a]),children:[e.jsx(T,{className:"h-9 w-[160px]",children:e.jsx(V,{placeholder:"Category"})}),e.jsxs(z,{children:[e.jsx(h,{value:"all",children:"All Categories"}),e.jsx(h,{value:"sedan",children:"Sedan"}),e.jsx(h,{value:"hatchback",children:"Hatchback"}),e.jsx(h,{value:"coupe",children:"Coupe"}),e.jsx(h,{value:"suv",children:"SUV"}),e.jsx(h,{value:"crossover",children:"Crossover"}),e.jsx(h,{value:"wagon",children:"Wagon"}),e.jsx(h,{value:"pickup",children:"Pickup"}),e.jsx(h,{value:"minivan",children:"Minivan"}),e.jsx(h,{value:"convertible",children:"Convertible"})]})]}),e.jsxs(I,{value:X[0]??"all",onValueChange:a=>de(a==="all"?[]:[a]),children:[e.jsx(T,{className:"h-9 w-[150px]",children:e.jsx(V,{placeholder:"Status"})}),e.jsxs(z,{children:[e.jsx(h,{value:"all",children:"All Status"}),e.jsx(h,{value:"available",children:"Available"}),e.jsx(h,{value:"reserved",children:"Reserved"})]})]}),e.jsx(K,{type:"number",placeholder:"Year from",className:"h-9 w-[120px]",value:ee,onChange:a=>Le(a.target.value)}),e.jsx(K,{type:"number",placeholder:"Year to",className:"h-9 w-[120px]",value:ae,onChange:a=>Me(a.target.value)}),e.jsx(K,{type:"number",placeholder:"Rate from",className:"h-9 w-[120px]",value:se,onChange:a=>Fe(a.target.value)}),e.jsx(K,{type:"number",placeholder:"Rate to",className:"h-9 w-[120px]",value:te,onChange:a=>Re(a.target.value)})]})}),b?e.jsx("p",{className:"text-muted-foreground",children:"Loading cars..."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:he.map(a=>e.jsxs("div",{className:`
  border rounded-lg p-3 transition-all duration-300
  ${a.car_accepted?"bg-green-500/10 border-green-500/40 hover:bg-green-500/20 shadow-[0_0_10px_rgba(34,197,94,0.4)]":"bg-red-500/10 border-red-500/40 hover:bg-red-500/20 shadow-[0_0_10px_rgba(239,68,68,0.4)]"}
`,children:[e.jsxs("div",{className:"relative h-36 mb-2 overflow-hidden rounded-md",children:[e.jsx("img",{src:ie(a.main_image_url),alt:a.make,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-2 right-2 z-20 flex flex-col items-end gap-0.5",children:[a.agent?.profile_picture?e.jsx("img",{src:a.agent.profile_picture.startsWith("http")?a.agent.profile_picture:`https://rento-lb.com/api/storage/${a.agent.profile_picture.replace(/^\/?storage\//,"")}`,alt:a.agent?.username,className:"w-8 h-8 rounded-full border-2 border-white shadow-md bg-white object-cover",onError:n=>{n.currentTarget.onerror=null,n.currentTarget.src="/avatar.png"}}):e.jsx("div",{className:"w-8 h-8 rounded-full border-2 border-white shadow-md bg-muted flex items-center justify-center",children:e.jsx(ve,{className:"w-4 h-4 text-muted-foreground"})}),a.agent?.username!=null&&a.agent.username!==""&&e.jsxs("span",{className:"text-[10px] font-medium text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)] bg-black/50 px-1.5 py-0.5 rounded max-w-[80px] truncate",title:a.agent.username,children:["@",a.agent.username]})]})]}),e.jsxs("h3",{className:"font-semibold text-sm",children:[a.make," ",a.model]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1 space-y-1",children:[e.jsxs("div",{children:["Year: ",a.year]}),e.jsxs("div",{children:["Rate: $",a.daily_rate]}),e.jsxs("div",{children:["Agent: ",a.agent?.username||"—"]}),e.jsxs("div",{children:["Views: ",a.views_count]})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-1",children:[e.jsx(E,{variant:"outline",children:a.car_category}),a.status==="available"&&e.jsx(E,{className:"bg-green-600",children:"Available"}),a.car_accepted?e.jsx(E,{className:"bg-green-500/20 text-green-700 border-green-500/40",children:"Accepted"}):e.jsx(E,{className:"bg-red-500/20 text-red-700 border-red-500/40",children:"Rejected"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx(_,{size:"icon",variant:"ghost",onClick:()=>Ee(a),children:e.jsx(qe,{className:"w-4 h-4"})}),e.jsx(_,{size:"icon",variant:"ghost",onClick:()=>De(a),children:e.jsx(We,{className:"w-4 h-4"})}),e.jsx(_,{size:"icon",variant:"ghost",onClick:()=>Te("Delete Car","Are you sure you want to delete this car?",()=>Ve(a.id)),children:e.jsx(He,{className:"w-4 h-4 text-red-500"})})]}),a.car_accepted?e.jsx(_,{size:"sm",variant:"outline",className:"h-7 text-xs",onClick:()=>xe(a),children:"Reject"}):e.jsx(_,{size:"sm",className:"h-7 text-xs",onClick:()=>pe(a),children:"Accept"})]})]},a.id))}),he.length===0&&e.jsx("div",{className:"text-center text-muted-foreground mt-10",children:"No cars found"}),o.last_page>1&&e.jsxs("div",{className:"flex flex-col items-center gap-3 mt-10",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing page ",e.jsx("span",{className:"font-semibold text-foreground",children:o.current_page})," ","of ",e.jsx("span",{className:"font-semibold text-foreground",children:o.last_page})," ","(",o.total," cars)"]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap justify-center",children:[e.jsx(_,{variant:"outline",size:"sm",disabled:o.current_page<=1,onClick:()=>x(a=>a-1),children:e.jsx(Qe,{size:16})}),Array.from({length:o.last_page},(a,n)=>n+1).filter(a=>a===1||a===o.last_page||Math.abs(a-o.current_page)<=2).map((a,n,u)=>e.jsx(_,{size:"sm",variant:a===o.current_page?"default":"outline",onClick:()=>x(a),children:a},a)),e.jsx(_,{variant:"outline",size:"sm",disabled:o.current_page>=o.last_page,onClick:()=>x(a=>a+1),children:e.jsx(Je,{size:16})})]})]})]}),e.jsx(je,{open:ke,onOpenChange:q,children:e.jsxs(_e,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(Ne,{children:e.jsx(ye,{children:ue==="view-car"?"Car Details":"Edit Car"})}),$?ue==="view-car"?e.jsx(na,{car:$,imgUrl:ie,getStorageUrl:ge,onEdit:()=>{Y({...$}),W("edit-car")},onClose:()=>q(!1),onAccept:()=>pe($),onReject:()=>xe($)}):Z&&e.jsx(ca,{car:Z,setCar:Y,imgUrl:ie,onClose:()=>W("view-car"),onSaved:a=>{U(a),Y({...a}),W("view-car")}}):e.jsx("p",{className:"text-muted-foreground",children:"Loading..."})]})})]})};async function Oa(s,v,i,o,y){const b=await v(s);b&&(i(b),o("view-car"),y(!0))}function na({car:s,imgUrl:v,getStorageUrl:i,onEdit:o,onClose:y,onAccept:b,onReject:j}){const c=s?.agent||null,x=g=>{if(!g)return"N/A";const k=Number(g);return Number.isNaN(k)?g:`$${k.toFixed(2)}`},l=({label:g,value:k})=>e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs text-muted-foreground uppercase tracking-wide",children:g}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:k??"N/A"})]}),S=({value:g})=>g?e.jsx(E,{className:"bg-green-500/20 text-green-700 border-green-500/40",children:"Yes"}):e.jsx(E,{className:"bg-red-500/20 text-red-700 border-red-500/40",children:"No"});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"relative rounded-xl overflow-hidden border",children:[e.jsx("img",{src:v(s.main_image_url),alt:s.make,className:"w-full h-[260px] object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"}),e.jsxs("div",{className:"absolute bottom-4 left-6 text-white",children:[e.jsxs("h2",{className:"text-2xl font-bold",children:[s.make," ",s.model]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(E,{className:"bg-white/20 backdrop-blur text-white",children:s.car_category}),s.car_accepted?e.jsx(E,{className:"bg-green-600",children:"Accepted"}):e.jsx(E,{className:"bg-red-600",children:"Rejected"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 p-4 rounded-xl border bg-background shadow-sm",children:[e.jsx(l,{label:"Year",value:s.year}),e.jsx(l,{label:"Color",value:s.color}),e.jsx(l,{label:"Transmission",value:s.transmission}),e.jsx(l,{label:"Fuel Type",value:s.fuel_type}),e.jsx(l,{label:"Seats",value:s.seats}),e.jsx(l,{label:"Doors",value:s.doors}),e.jsx(l,{label:"Daily Rate",value:x(s.daily_rate)}),e.jsx(l,{label:"Status",value:s.status})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"rounded-xl border p-4 space-y-3 bg-background shadow-sm",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Car Information"}),e.jsx(l,{label:"License Plate",value:s.license_plate}),e.jsx(l,{label:"Mileage",value:s.mileage}),e.jsx(l,{label:"Cylinder",value:s.cylinder_number}),e.jsx(l,{label:"Min Rental Days",value:s.min_rental_days}),e.jsxs("div",{className:"flex gap-4 pt-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Accepted"}),e.jsx(S,{value:s.car_accepted})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Private"}),e.jsx(S,{value:s.is_private})]})]})]}),e.jsxs("div",{className:"rounded-xl border p-4 space-y-3 bg-background shadow-sm",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Agent"}),e.jsx(l,{label:"Username",value:c?.username}),e.jsx(l,{label:"Phone",value:c?.phone_number}),e.jsx(l,{label:"Email",value:c?.email}),e.jsx(l,{label:"City",value:c?.city})]})]}),s.features?.length>0&&e.jsxs("div",{className:"rounded-xl border p-4 bg-background shadow-sm",children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Features"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.features.map((g,k)=>e.jsx(E,{variant:"outline",children:typeof g=="string"?g:g.name},k))})]}),s.notes&&e.jsxs("div",{className:"rounded-xl border p-4 bg-background shadow-sm",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Notes"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:s.notes})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[!s.car_accepted&&e.jsx(_,{className:"bg-green-600 hover:bg-green-700",onClick:b,children:"Accept Car"}),s.car_accepted&&e.jsx(_,{variant:"destructive",onClick:j,children:"Reject Car"}),e.jsx(_,{className:"flex-1",onClick:o,children:"Edit Car"}),e.jsx(_,{variant:"outline",onClick:y,children:"Close"})]})]})}const ra=[{type:"main",label:"Main",fullKey:"main_image_full_url",pathKey:"main_image_url"},{type:"front",label:"Front",fullKey:"front_image_full_url",pathKey:"front_image_url"},{type:"back",label:"Back",fullKey:"back_image_full_url",pathKey:"back_image_url"},{type:"left",label:"Left",fullKey:"left_image_full_url",pathKey:"left_image_url"},{type:"right",label:"Right",fullKey:"right_image_full_url",pathKey:"right_image_url"}];function f({label:s,type:v="text",disabled:i=!1,value:o="",onChange:y}){const b=j=>{const c=j.target.value;y(v==="number"?c===""?"":Number(c):c)};return e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:s}),e.jsx(K,{type:v,value:o,onChange:b,disabled:i})]})}function oe({label:s,options:v,emptySentinel:i,value:o="",onValueChange:y}){const b=i?(o??"")||i:String(o??""),j=c=>y(i&&c===i?"":c);return e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:s}),e.jsxs(I,{value:b,onValueChange:j,children:[e.jsx(T,{children:e.jsx(V,{placeholder:"Select..."})}),e.jsx(z,{children:v.map(c=>{const x=c.value===""||c.value==null?i||"__none__":String(c.value);return e.jsx(h,{value:x,children:c.label},x)})})]})]})}function Q({label:s,value:v,onChange:i}){return e.jsxs("div",{className:"flex items-center justify-between gap-3 py-2",children:[e.jsx("div",{className:"text-sm",children:s}),e.jsx("button",{type:"button",role:"switch","aria-checked":!!v,onClick:()=>i(!v),className:["relative inline-flex h-5 w-10 items-center rounded-full transition-colors",v?"bg-teal-600":"bg-muted","focus:outline-none focus:ring-2 focus:ring-teal-500/40"].join(" "),children:e.jsx("span",{className:["inline-block h-4 w-4 transform rounded-full bg-white transition-transform",v?"translate-x-5":"translate-x-1","shadow"].join(" ")})})]})}function ia({car:s,setVal:v}){const{toast:i}=ce(),[o,y]=m.useState(""),[b,j]=m.useState(!1),[c,x]=m.useState(null),l=s?.live_location||{address:"",latitude:0,longitude:0},S=l.latitude&&l.longitude&&(Number(l.latitude)!==0||Number(l.longitude)!==0),g=r=>v("live_location",{...l,...r}),k=()=>{const r=aa(o);r?(g({latitude:r.lat,longitude:r.lng}),i({title:"Coordinates applied"})):i({title:"Could not parse link",description:"Paste a valid Google Maps URL with coordinates",variant:"destructive"})},D=()=>{if(!navigator.geolocation){i({title:"Geolocation not supported",variant:"destructive"});return}navigator.geolocation.getCurrentPosition(r=>{g({latitude:r.coords.latitude,longitude:r.coords.longitude}),i({title:"Current location set"})},()=>i({title:"Could not get location",variant:"destructive"}))},G=()=>{const r=s?.agent?.location;if(r&&(r.lat!=null||r.latitude!=null)){const C=r.latitude??r.lat??33.8547,w=r.longitude??r.lng??35.8623;g({latitude:C,longitude:w}),i({title:"Office location set"})}else i({title:"No office location",description:"Car agent has no location set",variant:"destructive"})},t=()=>{x({latitude:l.latitude||33.8547,longitude:l.longitude||35.8623}),j(!0)},d=()=>{c&&(g({latitude:c.latitude,longitude:c.longitude}),i({title:"Location set from map"})),j(!1)};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm font-semibold flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4"}),"Location & Address (same as Add Car)"]}),e.jsxs("div",{className:"space-y-4 p-4 rounded-lg border bg-muted/30",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Address (region)"}),e.jsxs(I,{value:l.address||"__empty__",onValueChange:r=>g({address:r==="__empty__"?"":r}),children:[e.jsx(T,{children:e.jsx(V,{placeholder:"Select region..."})}),e.jsxs(z,{children:[e.jsx(h,{value:"__empty__",children:"Select region..."}),ea.filter(r=>r.value).map(r=>e.jsx(h,{value:r.value,children:r.label},r.value))]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Paste Google Maps link (to set coordinates)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(K,{placeholder:"e.g. https://www.google.com/maps/@33.89,35.50 or maps.app.goo.gl/...",value:o,onChange:r=>y(r.target.value),className:"flex-1"}),e.jsx(_,{type:"button",variant:"outline",size:"sm",onClick:k,children:"Apply"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(_,{type:"button",variant:"outline",size:"sm",onClick:D,children:[e.jsx(Xe,{className:"w-4 h-4 mr-2"}),"Use Current Location"]}),e.jsxs(_,{type:"button",variant:"outline",size:"sm",onClick:t,children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"Select on Map"]}),e.jsxs(_,{type:"button",variant:"outline",size:"sm",onClick:G,children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"Office location"]})]}),S?e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Location set: Lat ",l.latitude," • Lng ",l.longitude]}):e.jsx("div",{className:"text-xs text-muted-foreground",children:"No coordinates set yet."})]}),e.jsx(je,{open:b,onOpenChange:j,children:e.jsxs(_e,{className:"max-w-2xl",children:[e.jsx(Ne,{children:e.jsx(ye,{children:"Select location on map"})}),c&&e.jsx(oa,{center:c,selectedLocation:c,onLocationSelect:(r,C)=>x({latitude:r,longitude:C})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(_,{variant:"outline",onClick:()=>j(!1),children:"Cancel"}),e.jsx(_,{onClick:d,children:"Confirm"})]})]})})]})}function oa({center:s,selectedLocation:v,onLocationSelect:i}){const o=ne.useRef(null),y=ne.useRef(null),b="admin-edit-car-location-map";return ne.useEffect(()=>{if(!window.L||o.current)return;const j=parseFloat(s?.latitude)||33.8547,c=parseFloat(s?.longitude)||35.8623,x=window.L.map(b).setView([j,c],13);window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(x);const l=window.L.marker([j,c],{draggable:!0}).addTo(x);l.on("dragend",S=>{const g=S.target.getLatLng();i(g.lat,g.lng)}),x.on("click",S=>{l.setLatLng(S.latlng),i(S.latlng.lat,S.latlng.lng)}),o.current=x,y.current=l},[]),e.jsx("div",{id:b,className:"w-full h-[300px] rounded-md"})}function ca({car:s,setCar:v,imgUrl:i,onClose:o,onSaved:y}){const{toast:b}=ce(),[j,c]=m.useState(null),x=ne.useRef({}),l=(t,d)=>v(r=>({...r,[t]:d})),S=(t,d)=>{const r=s?.[t];return r||i(s?.[d])},g=async(t,d)=>{if(!(!d||!s?.id)){c(t);try{const r=await Ue(s.id,d,t),C=r.data||r,w=C?.car??C??s;v(w),b({title:"Image updated",description:`${t} image replaced successfully`})}catch(r){const C=r.response?.data?.errors?.image?.[0]||r.response?.data?.message||"Failed to replace image";b({title:"Error",description:C,variant:"destructive"})}finally{c(null),x.current[t]&&(x.current[t].value="")}}},k=t=>{if(t==null||t==="")return"";const d=Number(t);return Number.isNaN(d)?t:d},D=t=>!Array.isArray(t)||t.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"N/A"}):e.jsx("div",{className:"flex flex-wrap gap-2",children:t.map((d,r)=>e.jsx(E,{variant:"outline",children:typeof d=="string"?d:d?.name??JSON.stringify(d)},r))}),G=async()=>{try{const t={make:s.make,model:s.model,year:s.year,cylinder_number:s.cylinder_number==="__none__"||s.cylinder_number===""?void 0:s.cylinder_number,license_plate:s.license_plate,color:s.color,mileage:s.mileage,fuel_type:s.fuel_type,transmission:s.transmission,wheels_drive:s.wheels_drive,car_category:s.car_category,seats:s.seats,doors:s.doors,daily_rate:k(s.daily_rate),holiday_rate:k(s.holiday_rate),is_deposit:!!s.is_deposit,deposit:k(s.deposit),status:s.status,car_accepted:!!s.car_accepted,is_private:!!s.is_private,is_delivered:!!s.is_delivered,delivery_fees:k(s.delivery_fees),with_driver:!!s.with_driver,driver_fees:k(s.driver_fees),max_driving_mileage:s.max_driving_mileage!=null&&s.max_driving_mileage!==""?Number(s.max_driving_mileage):void 0,min_rental_days:s.min_rental_days,notes:s.notes,agent_id:s.agent_id!=null&&s.agent_id!==""?Number(s.agent_id):void 0,insurance_expiry:s.insurance_expiry||void 0,registration_expiry:s.registration_expiry||void 0,views_count:s.views_count!=null&&s.views_count!==""?Number(s.views_count):void 0,clicks_count:s.clicks_count!=null&&s.clicks_count!==""?Number(s.clicks_count):void 0,search_count:s.search_count!=null&&s.search_count!==""?Number(s.search_count):void 0},d=s?.live_location,r=d?.address??"",C=d?.latitude??d?.lat??"",w=d?.longitude??d?.lng??"";(r||C!==""&&w!=="")&&(t.live_location={address:String(r||""),latitude:C!==""?Number(C):0,longitude:w!==""?Number(w):0});const O=await Ye(s.id,t),B=O.data||O,J=B?.car??B??s;b({title:"Saved",description:"Car updated successfully"}),y?.(J)}catch(t){if(t.response?.status===422&&t.response?.data?.errors){const d=Object.entries(t.response.data.errors).map(([r,C])=>`${r}: ${(C||[]).join(", ")}`).join("; ");b({title:"Validation Error",description:d||"Invalid data",variant:"destructive"})}else b({title:"Error",description:"Failed to update car",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-3",children:[e.jsx(f,{label:"ID",value:s?.id??"",onChange:()=>{},disabled:!0}),e.jsx(f,{label:"Make",value:s?.make??"",onChange:t=>l("make",t)}),e.jsx(f,{label:"Model",value:s?.model??"",onChange:t=>l("model",t)}),e.jsx(f,{label:"Year",value:s?.year??"",onChange:t=>l("year",t),type:"number"}),e.jsx(oe,{label:"Cylinder",value:s?.cylinder_number??"",onValueChange:t=>l("cylinder_number",t),emptySentinel:"__none__",options:[{label:"—",value:""},{label:"4",value:"4"},{label:"6",value:"6"},{label:"8",value:"8"},{label:"10",value:"10"},{label:"12",value:"12"}]}),e.jsx(f,{label:"License Plate",value:s?.license_plate??"",onChange:t=>l("license_plate",t)}),e.jsx(f,{label:"Color",value:s?.color??"",onChange:t=>l("color",t)}),e.jsx(f,{label:"Mileage",value:s?.mileage??"",onChange:t=>l("mileage",t),type:"number"}),e.jsx(f,{label:"Fuel Type",value:s?.fuel_type??"",onChange:t=>l("fuel_type",t)}),e.jsx(f,{label:"Transmission",value:s?.transmission??"",onChange:t=>l("transmission",t)}),e.jsx(f,{label:"Wheels Drive",value:s?.wheels_drive??"",onChange:t=>l("wheels_drive",t)}),e.jsx(oe,{label:"Category",value:s?.car_category??"",onValueChange:t=>l("car_category",t),emptySentinel:"__none__",options:[{label:"—",value:""},{label:"Sedan",value:"Sedan"},{label:"Hatchback",value:"Hatchback"},{label:"Coupe",value:"Coupe"},{label:"SUV",value:"SUV"},{label:"Crossover",value:"Crossover"},{label:"Wagon",value:"Wagon"},{label:"Pickup",value:"Pickup"},{label:"Minivan",value:"Minivan"},{label:"Convertible",value:"Convertible"}]}),e.jsx(f,{label:"Seats",value:s?.seats??"",onChange:t=>l("seats",t),type:"number"}),e.jsx(f,{label:"Doors",value:s?.doors??"",onChange:t=>l("doors",t),type:"number"}),e.jsx(f,{label:"Daily Rate",value:s?.daily_rate??"",onChange:t=>l("daily_rate",t),type:"number"}),e.jsx(f,{label:"Holiday Rate",value:s?.holiday_rate??"",onChange:t=>l("holiday_rate",t),type:"number"}),e.jsx(f,{label:"Deposit",value:s?.deposit??"",onChange:t=>l("deposit",t),type:"number"}),e.jsx(f,{label:"Delivery Fees",value:s?.delivery_fees??"",onChange:t=>l("delivery_fees",t),type:"number"}),e.jsx(f,{label:"Driver Fees",value:s?.driver_fees??"",onChange:t=>l("driver_fees",t),type:"number"}),e.jsx(f,{label:"Min Rental Days",value:s?.min_rental_days??"",onChange:t=>l("min_rental_days",t),type:"number"}),e.jsx(f,{label:"Max Driving Mileage",value:s?.max_driving_mileage??"",onChange:t=>l("max_driving_mileage",t),type:"number"}),e.jsx(f,{label:"Agent ID (reassign owner)",value:s?.agent_id??"",onChange:t=>l("agent_id",t),type:"number"}),e.jsx(f,{label:"Insurance Expiry",value:s?.insurance_expiry??"",onChange:t=>l("insurance_expiry",t),type:"date"}),e.jsx(f,{label:"Registration Expiry",value:s?.registration_expiry??"",onChange:t=>l("registration_expiry",t),type:"date"}),e.jsx(f,{label:"Views Count",value:s?.views_count??"",onChange:t=>l("views_count",t),type:"number"}),e.jsx(f,{label:"Clicks Count",value:s?.clicks_count??"",onChange:t=>l("clicks_count",t),type:"number"}),e.jsx(f,{label:"Search Count",value:s?.search_count??"",onChange:t=>l("search_count",t),type:"number"})]}),e.jsx("div",{className:"border-t pt-3"}),e.jsx(ia,{car:s,setVal:l}),e.jsx("div",{className:"border-t pt-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Features"}),D(s?.features)]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Add-ons"}),D(s?.add_ons)]}),e.jsx("div",{className:"border-t pt-3"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Car Images"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Main"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{ref:t=>x.current.main=t,type:"file",accept:"image/jpeg,image/jpg,image/png",className:"hidden",onChange:t=>{const d=t.target.files?.[0];d&&g("main",d)}}),e.jsx(_,{type:"button",variant:"outline",size:"sm",disabled:j==="main",onClick:()=>x.current.main?.click(),children:j==="main"?"Uploading…":"Replace"})]})]}),e.jsx("a",{href:S("main_image_full_url","main_image_url"),target:"_blank",rel:"noreferrer",children:e.jsx("img",{src:S("main_image_full_url","main_image_url"),alt:"Main",className:"w-full max-h-[260px] object-cover rounded-md border"})})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:ra.filter(t=>t.type!=="main").map(({type:t,label:d,fullKey:r,pathKey:C})=>e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-1",children:[e.jsx("span",{className:"text-muted-foreground",children:d}),e.jsx("input",{ref:w=>x.current[t]=w,type:"file",accept:"image/jpeg,image/jpg,image/png",className:"hidden",onChange:w=>{const O=w.target.files?.[0];O&&g(t,O)}}),e.jsx(_,{type:"button",variant:"outline",size:"sm",className:"h-7 px-1",disabled:j===t,onClick:()=>x.current[t]?.click(),children:j===t?"…":"Replace"})]}),e.jsx("a",{href:S(r,C),target:"_blank",rel:"noreferrer",children:e.jsx("img",{src:S(r,C),alt:d,className:"h-[120px] w-full object-cover rounded-md border"})})]},t))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(oe,{label:"Status",value:s?.status??"",onValueChange:t=>l("status",t),options:[{label:"Available",value:"available"},{label:"Not Available",value:"not_available"},{label:"Rented",value:"rented"},{label:"Maintenance",value:"maintenance"}]}),e.jsx("div",{className:"text-sm font-semibold",children:"Notes"}),e.jsx("textarea",{className:"w-full border rounded-md p-2 min-h-[90px]",value:s?.notes??"",onChange:t=>l("notes",t.target.value)})]}),e.jsx(Q,{label:"Car Accepted",value:s?.car_accepted,onChange:t=>l("car_accepted",t?1:0)}),e.jsx(Q,{label:"Is Private",value:s?.is_private,onChange:t=>l("is_private",t?1:0)}),e.jsx(Q,{label:"Is Deposit",value:s?.is_deposit,onChange:t=>l("is_deposit",t?1:0)}),e.jsx(Q,{label:"With Driver",value:s?.with_driver,onChange:t=>l("with_driver",t?1:0)}),e.jsx(Q,{label:"Is Delivered",value:s?.is_delivered,onChange:t=>l("is_delivered",t?1:0)}),e.jsxs("div",{className:"pt-3 flex gap-2",children:[e.jsx(_,{className:"flex-1",onClick:G,children:"Update Car"}),e.jsx(_,{variant:"outline",className:"w-28",onClick:o,children:"Cancel"})]})]})}export{za as default,Oa as openCarView};
