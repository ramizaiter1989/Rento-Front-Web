import{r as o,b as f,j as e,X as Z,a as M,P as ee,e as re,C as ae}from"./index-DbvXYXc0.js";import{P as te,S as se,a as ne,b as ie}from"./pusher-BchfI1AD.js";import{m as c}from"./proxy-Rx_HuwO6.js";import{M as N}from"./message-circle-CPCE0lxB.js";import{A as F}from"./index-B12qvIYV.js";import{S as oe}from"./search-DsOkoVxz.js";import{S as I}from"./shield-Bm-1xR-G.js";import{C as le}from"./chevron-right-DaEW3pZI.js";import{C as ce}from"./check-check-DZSXyF6p.js";import{C as de}from"./check-nqnuVgMJ.js";import{S as ue}from"./send-DKa36EPT.js";import"./use-presence-CB-MpOZZ.js";const n={darkBlue:"#0E4C81",teal:"#008C95",limeGreen:"#8AC640",tealDim:"rgba(0, 140, 149, 0.1)",limeGreenDim:"rgba(138, 198, 64, 0.1)"};function _e(){const[p,v]=o.useState([]),[i,U]=o.useState(null),[y,j]=o.useState([]),[w,k]=o.useState(""),[L,S]=o.useState(!1),[O,E]=o.useState(!0),[G,D]=o.useState(!1),[H,m]=o.useState(null),[_,z]=o.useState(""),R=o.useRef(null),q=o.useRef(null),d=o.useRef(null),g=o.useRef(null),C=o.useRef(null),[h]=o.useState(()=>localStorage.getItem("token")),K=(r,a)=>{const t=r?.created_at??r?.createdAt??r?.data?.created_at??null,s=r?.read_at??r?.data?.read_at??(r?.is_read?t:null);return{id:r?.id??r?.data?.id??`rt-${Date.now()}`,booking_id:r?.booking_id??r?.data?.booking_id??a,sender_id:r?.sender_id??r?.data?.sender_id??r?.sender?.id,receiver_id:r?.receiver_id??r?.data?.receiver_id??null,message:r?.message??r?.data?.message??"",read_at:s,created_at:t,sender:r?.sender??r?.data?.sender??null}};o.useEffect(()=>{if(!h){m("Authentication required. Please log in.");return}window.Pusher=te,d.current=new se({broadcaster:"pusher",key:"316e84fa5f5bf1a94b26",cluster:"ap1",forceTLS:!0,encrypted:!0,enabledTransports:["ws","wss"],authEndpoint:"https://rento-lb.com/api/api/broadcasting/auth",auth:{headers:{Authorization:`Bearer ${h}`,Accept:"application/json"}}});const r=d.current.connector.pusher;r.connection.bind("initialized",()=>console.log("[PUSHER] initialized")),r.connection.bind("connecting",()=>console.log("[PUSHER] connecting...")),r.connection.bind("connected",()=>console.log("[PUSHER] ✅ connected")),r.connection.bind("disconnected",()=>console.log("[PUSHER] disconnected")),r.connection.bind("unavailable",()=>console.log("[PUSHER] unavailable")),r.connection.bind("failed",()=>console.log("[PUSHER] ❌ failed")),r.connection.bind("error",a=>console.error("[PUSHER] error:",a)),console.log("[ECHO] authEndpoint:","https://rento-lb.com/api/api/broadcasting/auth"),console.log("[ECHO] cluster:","ap1"),console.log("[ECHO] key:","316e84fa5f5bf1a94b26");try{d.current.connector?.pusher?.connection?.bind("error",a=>{console.error("Pusher connection error:",a)})}catch{}return f.get("/profile").then(({data:a})=>{g.current=a.user?.id,console.log("Current user ID:",g.current)}).catch(a=>{console.error("Failed to fetch profile:",a),m("Failed to load user profile")}),()=>{d.current?.disconnect()}},[h]),o.useEffect(()=>{h&&Q()},[h]);const Q=async()=>{E(!0),m(null);try{const{data:r}=await f.get("/bookings"),t=(r?.bookings?.data??[]).filter(s=>s.booking_request_status==="confirmed"||s.booking_request_status==="accepted");v(t)}catch(r){console.error("Failed to fetch bookings:",r),m("Failed to load bookings"),v([])}finally{E(!1)}},J=()=>{const r=R.current;r&&(r.scrollTop=r.scrollHeight)};o.useEffect(()=>{J()},[y]);const W=async r=>{S(!0),m(null);try{const{data:a}=await f.get(`/bookings/${r}/chat`),t=a?.data?.data??a?.data?.messages??a?.messages??[];j(t),t.forEach(s=>{!s.read_at&&s.sender_id!==g.current&&B(r,s.id)})}catch(a){console.error("Failed to load messages:",a),m("Failed to load messages"),j([])}finally{S(!1)}};o.useEffect(()=>{if(!i?.id||!d.current)return;const r=i.id,a=`private-booking.${r}`;console.log("[ECHO] subscribing to:",a);const t=d.current.connector.pusher,s=t.subscribe(a);s.bind("pusher:subscription_succeeded",()=>{console.log("[PUSHER] ✅ subscription_succeeded:",a)}),s.bind("pusher:subscription_error",u=>{console.error("[PUSHER] ❌ subscription_error:",a,"status:",u),console.error("-> If status=403, your /broadcasting/auth or channels.php auth is rejecting the user.")});const l=d.current.private(`booking.${r}`),x=u=>{const b=K(u,r);j($=>$.some(V=>String(V.id)===String(b.id))?$:[...$,b]),b.sender_id&&b.sender_id!==g.current&&B(r,b.id)};return l.listen(".message.sent",x),l.listen("message.sent",x),l.listenForWhisper("typing",u=>{u?.user_id&&u.user_id!==g.current&&(D(!0),C.current&&clearTimeout(C.current),C.current=setTimeout(()=>D(!1),3e3))}),l.listen(".message.read",u=>console.log("[ECHO] message.read:",u)),W(r),()=>{console.log("[ECHO] leaving:",a),d.current?.leave(`booking.${r}`),t.unsubscribe(a)}},[i?.id]);const A=async r=>{if(r.preventDefault(),!w.trim()||!i?.id)return;const a=i.id,t=w.trim();k("");try{const{data:s}=await f.post(`/bookings/${a}/chat`,{booking_id:a,message:t}),l=s?.data??s?.message;l&&j(x=>[...x,l])}catch(s){console.error("Failed to send message:",s),m("Failed to send message"),k(t)}},B=async(r,a)=>{try{await f.post(`/bookings/${r}/chat/mark-read`,{message_id:a})}catch(t){console.error("Failed to mark message as read:",t)}},T=async()=>{try{if(!p?.length)return;const r=await Promise.all(p.map(async t=>{try{const{data:s}=await f.get(`/bookings/${t.id}/chat/unread-count`),l=s?.data?.unread_count??s?.data??s?.unread_count??0;return{id:t.id,count:Number(l)||0}}catch(s){return console.error(`Failed unread count for booking ${t.id}:`,s),{id:t.id,count:0}}})),a=Object.fromEntries(r.map(t=>[t.id,t.count]));v(t=>t.map(s=>({...s,unread_count:a[s.id]??0})))}catch(r){console.error("Failed to fetch unread counts:",r)}};o.useEffect(()=>{if(!h)return;p.length&&T();const r=setInterval(T,1e4);return()=>clearInterval(r)},[h,p.length]);const X=r=>{if(!r)return"";const a=new Date(r);if(Number.isNaN(a.getTime()))return"";const s=Math.floor((new Date-a)/6e4);if(s<1)return"Just now";if(s<60)return`${s}m ago`;const l=Math.floor(s/60);if(l<24)return`${l}h ago`;const x=Math.floor(l/24);return x<7?`${x}d ago`:a.toLocaleDateString("en-US",{month:"short",day:"numeric"})},Y=r=>{if(!r)return"";const a=new Date(r);return Number.isNaN(a.getTime())?"":a.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},P=p.filter(r=>{if(!_)return!0;const a=_.toLowerCase(),t=`${r.car?.agent?.first_name||""} ${r.car?.agent?.last_name||""}`.toLowerCase(),s=`${r.car?.make||""} ${r.car?.model||""}`.toLowerCase();return t.includes(a)||s.includes(a)});return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50 dark:from-black dark:via-gray-900 dark:to-gray-950 pt-20",children:e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsx(c.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl flex items-center justify-center shadow-lg",style:{background:`linear-gradient(135deg, ${n.teal}, ${n.darkBlue})`},children:e.jsx(N,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-clip-text text-transparent",style:{backgroundImage:`linear-gradient(135deg, ${n.darkBlue}, ${n.teal}, ${n.limeGreen})`},children:"My Bookings Chat"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Message your car agent"})]})]})}),e.jsx(F,{children:H&&e.jsx(c.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"mb-4 p-4 rounded-xl border-2",style:{background:"rgba(220, 38, 38, 0.1)",borderColor:"#DC2626"},children:e.jsxs("p",{className:"text-red-800 dark:text-red-200 flex items-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5"}),H]})})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-180px)]",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-200 dark:border-gray-700",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:_,onChange:r=>z(r.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 dark:text-white text-sm"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:O?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-t-transparent",style:{borderColor:n.tealDim,borderTopColor:"transparent"}})}):P.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-gray-400",children:[e.jsx(N,{className:"w-16 h-16 mb-3",style:{color:n.teal,opacity:.3}}),e.jsx("p",{className:"text-center font-medium",children:"No bookings found"}),e.jsx("p",{className:"text-xs text-center mt-1",children:"Book a car to start chatting"})]}):P.map(r=>{const a=r.car?.agent,t=a?.profile_picture?`/api/storage/${a.profile_picture}`:"/default-avatar.png";return e.jsx(c.div,{whileHover:{x:5},onClick:()=>U(r),className:`p-4 border-b border-gray-200 dark:border-gray-700 cursor-pointer transition-all ${i?.id===r.id?"border-l-4":"hover:bg-gray-50 dark:hover:bg-gray-700"}`,style:i?.id===r.id?{background:n.tealDim,borderLeftColor:n.teal}:{},children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:t,alt:a?.first_name||"Agent",className:"w-12 h-12 rounded-full object-cover ring-2 ring-white dark:ring-gray-700"}),(r.unread_count??0)>0&&e.jsx(c.div,{animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0},className:"absolute -top-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center shadow-lg",style:{background:n.limeGreen},children:e.jsx("span",{className:"text-xs text-white font-bold",children:r.unread_count})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 dark:text-white truncate flex items-center gap-1",children:[a?.first_name||"N/A"," ",a?.last_name||"",a?.verified_by_admin&&e.jsx(I,{className:"w-3 h-3",style:{color:n.teal}})]}),(r.unread_count??0)>0&&e.jsx(le,{className:"w-4 h-4",style:{color:n.teal}})]}),e.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400 truncate flex items-center gap-1",children:[e.jsx(M,{className:"w-3 h-3"}),r.car?.make||"N/A"," ",r.car?.model||""]})]})]})},r.id)})})]}),e.jsx("div",{className:"lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden flex flex-col border border-gray-200 dark:border-gray-700",children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 text-white relative overflow-hidden",style:{background:`linear-gradient(135deg, ${n.darkBlue}, ${n.teal}, ${n.limeGreen})`},children:[e.jsx("div",{className:"absolute top-0 right-0 w-48 h-48 bg-white/10 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-32 h-32 bg-white/10 rounded-full blur-2xl"}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:i.car?.agent?.profile_picture?`/api/storage/${i.car.agent.profile_picture}`:"/default-avatar.png",alt:i.car?.agent?.first_name||"Agent",className:"w-12 h-12 rounded-full object-cover border-2 border-white shadow-lg"}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-bold flex items-center gap-2",children:[i.car?.agent?.first_name||"N/A"," ",i.car?.agent?.last_name||"",i.car?.agent?.verified_by_admin&&e.jsx(I,{className:"w-4 h-4"})]}),e.jsx("p",{className:"text-xs opacity-90",children:"Car Agent"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[i.car?.agent?.phone_number&&e.jsx(c.a,{whileHover:{scale:1.1},whileTap:{scale:.9},href:`tel:${i.car.agent.phone_number}`,className:"p-2 bg-white/20 backdrop-blur-sm rounded-xl hover:bg-white/30 transition-colors",children:e.jsx(ee,{className:"w-4 h-4"})}),i.car?.agent?.email&&e.jsx(c.a,{whileHover:{scale:1.1},whileTap:{scale:.9},href:`mailto:${i.car.agent.email}`,className:"p-2 bg-white/20 backdrop-blur-sm rounded-xl hover:bg-white/30 transition-colors",children:e.jsx(re,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"p-3 bg-white/10 backdrop-blur-sm rounded-xl",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4"}),e.jsxs("span",{className:"truncate",children:[i.car?.make||"N/A"," ",i.car?.model||""]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate",children:i.start_datetime?Y(i.start_datetime):"N/A"})]})]})})]})]}),e.jsxs("div",{ref:R,className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-gray-50/50 to-white dark:from-gray-900/50 dark:to-gray-800",style:{maxHeight:"calc(100vh - 450px)"},children:[L?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-4 border-t-transparent",style:{borderColor:n.tealDim,borderTopColor:"transparent"}})}):y.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx("div",{className:"w-20 h-20 rounded-full flex items-center justify-center mb-4",style:{background:n.tealDim},children:e.jsx(N,{className:"w-10 h-10",style:{color:n.teal}})}),e.jsx("p",{className:"text-lg font-medium",children:"No messages yet"}),e.jsx("p",{className:"text-sm",children:"Start the conversation!"})]}):e.jsxs(e.Fragment,{children:[y.map((r,a)=>{const t=r.sender_id===g.current||r.sender?.id===g.current,s=y[a-1],l=a===0||s?.sender_id!==r.sender_id;return e.jsxs(c.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`flex items-end gap-2 ${t?"justify-end":"justify-start"}`,children:[!t&&l&&e.jsx("img",{src:r.sender?.profile_picture?`/api/storage/${r.sender.profile_picture}`:"/default-avatar.png",alt:r.sender?.first_name||"User",className:"w-8 h-8 rounded-full object-cover ring-2 ring-white dark:ring-gray-700"}),!t&&!l&&e.jsx("div",{className:"w-8"}),e.jsxs("div",{className:`flex flex-col ${t?"items-end":"items-start"} max-w-[70%]`,children:[e.jsx(c.div,{whileHover:{scale:1.02},className:`rounded-2xl px-4 py-2 shadow-md ${t?"text-white rounded-br-none":"bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-bl-none border border-gray-200 dark:border-gray-600"}`,style:t?{background:`linear-gradient(135deg, ${n.teal}, ${n.darkBlue})`}:{},children:e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words leading-relaxed",children:r.message})}),e.jsxs("div",{className:"flex items-center gap-1 mt-1 px-1",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:X(r.created_at)}),t&&e.jsx("span",{children:r.read_at?e.jsx(ce,{className:"w-3 h-3",style:{color:n.teal}}):e.jsx(de,{className:"w-3 h-3 text-gray-400"})})]})]}),t&&l&&e.jsx("img",{src:r.sender?.profile_picture?`/api/storage/${r.sender.profile_picture}`:"/default-avatar.png",alt:r.sender?.first_name||"You",className:"w-8 h-8 rounded-full object-cover ring-2 ring-white dark:ring-gray-700"}),t&&!l&&e.jsx("div",{className:"w-8"})]},r.id)}),e.jsx("div",{ref:q})]}),e.jsx(F,{children:G&&e.jsxs(c.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"flex items-center gap-2",children:[e.jsx("img",{src:i.car?.agent?.profile_picture?`/api/storage/${i.car.agent.profile_picture}`:"/default-avatar.png",alt:i.car?.agent?.first_name||"Agent",className:"w-8 h-8 rounded-full object-cover ring-2 ring-white dark:ring-gray-700"}),e.jsx("div",{className:"bg-white dark:bg-gray-700 rounded-2xl rounded-bl-none px-4 py-3 border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full animate-bounce",style:{background:n.teal,animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 rounded-full animate-bounce",style:{background:n.darkBlue,animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 rounded-full animate-bounce",style:{background:n.limeGreen,animationDelay:"300ms"}})]})})]})})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",children:e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(c.button,{whileHover:{scale:1.1},whileTap:{scale:.9},className:"p-2 rounded-xl transition-colors",style:{background:n.tealDim,color:n.teal},type:"button",children:e.jsx(ne,{className:"w-5 h-5"})}),e.jsx(c.button,{whileHover:{scale:1.1},whileTap:{scale:.9},className:"p-2 rounded-xl transition-colors",style:{background:n.limeGreenDim,color:n.limeGreen},type:"button",children:e.jsx(ie,{className:"w-5 h-5"})}),e.jsx("div",{className:"flex-1 relative",children:e.jsx("textarea",{value:w,onChange:r=>{k(r.target.value)},onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),A(r))},placeholder:"Type your message...",rows:1,className:"w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 dark:bg-gray-700 dark:text-white resize-none"})}),e.jsx(c.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:A,disabled:!w.trim(),className:"p-3 rounded-xl text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl",style:{background:`linear-gradient(135deg, ${n.teal}, ${n.darkBlue})`},type:"button",children:e.jsx(ue,{className:"w-5 h-5"})})]})})]}):e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center",children:e.jsxs(c.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 rounded-full flex items-center justify-center mb-6 mx-auto",style:{background:`linear-gradient(135deg, ${n.tealDim}, ${n.limeGreenDim})`},children:e.jsx(N,{className:"w-12 h-12",style:{color:n.teal}})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Select a Booking"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Choose a conversation to start chatting"})]})})})]})]})})}export{_e as ClientBookingChat};
